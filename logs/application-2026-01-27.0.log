2026-01-27 11:05:03 [http-nio-8080-exec-3] DEBUG o.s.security.web.FilterChainProxy - Securing POST /login
2026-01-27 11:05:03 [http-nio-8080-exec-3] DEBUG o.s.security.web.csrf.CsrfFilter - Invalid CSRF token found for http://empanadas.localhost:8080/login
2026-01-27 11:05:03 [http-nio-8080-exec-3] DEBUG o.s.s.w.a.AccessDeniedHandlerImpl - Forwarding to /acceso-denegado with status code 403
2026-01-27 11:05:03 [http-nio-8080-exec-3] DEBUG o.s.security.web.FilterChainProxy - Securing POST /acceso-denegado
2026-01-27 11:05:03 [http-nio-8080-exec-3] DEBUG o.s.security.web.FilterChainProxy - Secured POST /acceso-denegado
2026-01-27 11:05:03 [http-nio-8080-exec-3] WARN  o.s.w.s.m.s.DefaultHandlerExceptionResolver - Resolved [org.springframework.web.HttpRequestMethodNotSupportedException: Request method 'POST' is not supported]
2026-01-27 11:05:03 [http-nio-8080-exec-3] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2026-01-27 11:05:03 [http-nio-8080-exec-3] DEBUG o.s.security.web.FilterChainProxy - Securing POST /error
2026-01-27 11:05:03 [http-nio-8080-exec-3] DEBUG o.s.security.web.FilterChainProxy - Secured POST /error
2026-01-27 11:05:03 [http-nio-8080-exec-3] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2026-01-27 11:05:06 [http-nio-8080-exec-4] DEBUG o.s.security.web.FilterChainProxy - Securing GET /login?logout
2026-01-27 11:05:06 [http-nio-8080-exec-4] DEBUG o.s.security.web.FilterChainProxy - Secured GET /login?logout
2026-01-27 11:05:06 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /login, M√©todo: GET
2026-01-27 11:05:06 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:06 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:06 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:06 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:06 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 358
2026-01-27 11:05:06 [http-nio-8080-exec-4] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:06 [http-nio-8080-exec-4] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2026-01-27 11:05:06 [http-nio-8080-exec-4] INFO  j.s.s.controladores.InicioController - üîê GET /login - Mostrando p√°gina de login
2026-01-27 11:05:06 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 358, Tenant anterior: 3
2026-01-27 11:05:06 [http-nio-8080-exec-4] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 358, Request: /login, Empresa ID anterior: 3
2026-01-27 11:05:09 [http-nio-8080-exec-5] DEBUG o.s.security.web.FilterChainProxy - Securing GET /login?logout
2026-01-27 11:05:09 [http-nio-8080-exec-5] DEBUG o.s.security.web.FilterChainProxy - Secured GET /login?logout
2026-01-27 11:05:09 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /login, M√©todo: GET
2026-01-27 11:05:09 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:09 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:09 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:09 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:09 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 359
2026-01-27 11:05:09 [http-nio-8080-exec-5] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:09 [http-nio-8080-exec-5] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2026-01-27 11:05:09 [http-nio-8080-exec-5] INFO  j.s.s.controladores.InicioController - üîê GET /login - Mostrando p√°gina de login
2026-01-27 11:05:09 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 359, Tenant anterior: 3
2026-01-27 11:05:09 [http-nio-8080-exec-5] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 359, Request: /login, Empresa ID anterior: 3
2026-01-27 11:05:10 [http-nio-8080-exec-6] DEBUG o.s.security.web.FilterChainProxy - Securing GET /login?logout
2026-01-27 11:05:10 [http-nio-8080-exec-6] DEBUG o.s.security.web.FilterChainProxy - Secured GET /login?logout
2026-01-27 11:05:10 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /login, M√©todo: GET
2026-01-27 11:05:10 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:10 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:10 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:10 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:10 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 360
2026-01-27 11:05:10 [http-nio-8080-exec-6] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:10 [http-nio-8080-exec-6] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2026-01-27 11:05:10 [http-nio-8080-exec-6] INFO  j.s.s.controladores.InicioController - üîê GET /login - Mostrando p√°gina de login
2026-01-27 11:05:10 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 360, Tenant anterior: 3
2026-01-27 11:05:10 [http-nio-8080-exec-6] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 360, Request: /login, Empresa ID anterior: 3
2026-01-27 11:05:10 [http-nio-8080-exec-7] DEBUG o.s.security.web.FilterChainProxy - Securing GET /login?logout
2026-01-27 11:05:10 [http-nio-8080-exec-7] DEBUG o.s.security.web.FilterChainProxy - Secured GET /login?logout
2026-01-27 11:05:10 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /login, M√©todo: GET
2026-01-27 11:05:10 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:10 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:10 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:10 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:10 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 361
2026-01-27 11:05:10 [http-nio-8080-exec-7] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:10 [http-nio-8080-exec-7] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2026-01-27 11:05:10 [http-nio-8080-exec-7] INFO  j.s.s.controladores.InicioController - üîê GET /login - Mostrando p√°gina de login
2026-01-27 11:05:10 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 361, Tenant anterior: 3
2026-01-27 11:05:10 [http-nio-8080-exec-7] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 361, Request: /login, Empresa ID anterior: 3
2026-01-27 11:05:10 [http-nio-8080-exec-8] DEBUG o.s.security.web.FilterChainProxy - Securing GET /login?logout
2026-01-27 11:05:10 [http-nio-8080-exec-8] DEBUG o.s.security.web.FilterChainProxy - Secured GET /login?logout
2026-01-27 11:05:10 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /login, M√©todo: GET
2026-01-27 11:05:10 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:10 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:10 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:10 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:10 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 362
2026-01-27 11:05:10 [http-nio-8080-exec-8] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:10 [http-nio-8080-exec-8] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2026-01-27 11:05:10 [http-nio-8080-exec-8] INFO  j.s.s.controladores.InicioController - üîê GET /login - Mostrando p√°gina de login
2026-01-27 11:05:10 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 362, Tenant anterior: 3
2026-01-27 11:05:10 [http-nio-8080-exec-8] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 362, Request: /login, Empresa ID anterior: 3
2026-01-27 11:05:14 [http-nio-8080-exec-9] DEBUG o.s.security.web.FilterChainProxy - Securing POST /login
2026-01-27 11:05:14 [http-nio-8080-exec-9] DEBUG j.s.s.servicios.UsuarioServicio - Autenticando usuario: admin para la empresa ID: null
2026-01-27 11:05:14 [http-nio-8080-exec-9] INFO  j.s.s.servicios.UsuarioServicio - üîê Login - Usuario: admin | Subdominio: empanadas
2026-01-27 11:05:14 [http-nio-8080-exec-9] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:14 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:14 [http-nio-8080-exec-9] DEBUG j.s.s.servicios.UsuarioServicio - üîê Login - Usuario: admin | Subdominio: empanadas | Empresa ID: 3 | Empresa Nombre: Las Empanadas
2026-01-27 11:05:14 [http-nio-8080-exec-9] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:14 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:14 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:14 [http-nio-8080-exec-9] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:14 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:14 [http-nio-8080-exec-9] INFO  j.s.s.servicios.UsuarioServicio - üîê Encontrado usuario: admin
2026-01-27 11:05:14 [http-nio-8080-exec-9] INFO  j.s.s.servicios.UsuarioServicio - üîê Rol: ADMIN
2026-01-27 11:05:14 [http-nio-8080-exec-9] DEBUG j.s.s.servicios.UsuarioServicio - üîê Activo: true
2026-01-27 11:05:14 [http-nio-8080-exec-9] DEBUG o.s.s.a.d.DaoAuthenticationProvider - Authenticated user
2026-01-27 11:05:14 [http-nio-8080-exec-9] DEBUG o.s.s.w.a.s.ChangeSessionIdAuthenticationStrategy - Changed session id from E225B8201C9D86085247C31DED0AF13B
2026-01-27 11:05:14 [http-nio-8080-exec-9] DEBUG o.s.s.w.c.CsrfAuthenticationStrategy - Replaced CSRF Token
2026-01-27 11:05:14 [http-nio-8080-exec-9] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Stored SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]] to HttpSession [org.apache.catalina.session.StandardSessionFacade@581c7b27]
2026-01-27 11:05:14 [http-nio-8080-exec-9] DEBUG o.s.s.w.a.UsernamePasswordAuthenticationFilter - Set SecurityContextHolder to UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]
2026-01-27 11:05:14 [http-nio-8080-exec-9] DEBUG o.s.s.web.DefaultRedirectStrategy - Redirecting to /principal
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG o.s.security.web.FilterChainProxy - Securing GET /principal
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG o.s.security.web.FilterChainProxy - Secured GET /principal
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /principal, M√©todo: GET
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:14 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 364
2026-01-27 11:05:14 [http-nio-8080-exec-10] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:14 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:14 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:14 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG j.s.s.config.CierreDiarioInterceptor - üõ°Ô∏è Interceptor ejecutando - Ruta: /principal, Empresa ID: 3
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG j.s.s.config.CierreDiarioInterceptor - üìÖ Validaci√≥n de cierre - Fecha: 2026-01-27, Hora: 11:00
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG org.hibernate.SQL - 
    select
        case 
            when count(cid1_0.id)>0 
                then 1 
            else 0 
    end 
from
    cierre_inventario_diario cid1_0 
where
    cid1_0.fecha=? 
    and cid1_0.estado=? 
    and cid1_0.empresa_id=?
2026-01-27 11:05:14 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:DATE) <- [2026-01-27]
2026-01-27 11:05:14 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:VARCHAR) <- [COMPLETADO]
2026-01-27 11:05:14 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (3:BIGINT) <- [3]
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG j.s.s.config.CierreDiarioInterceptor - ‚úÖ Despu√©s de las 5:00 AM ‚Üí Validar AYER: 2026-01-26
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG org.hibernate.SQL - 
    select
        case 
            when count(cid1_0.id)>0 
                then 1 
            else 0 
    end 
from
    cierre_inventario_diario cid1_0 
where
    cid1_0.fecha=? 
    and cid1_0.estado=? 
    and cid1_0.empresa_id=?
2026-01-27 11:05:14 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:DATE) <- [2026-01-26]
2026-01-27 11:05:14 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:VARCHAR) <- [COMPLETADO]
2026-01-27 11:05:14 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (3:BIGINT) <- [3]
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG j.s.s.config.CierreDiarioInterceptor - ¬øD√≠a 2026-01-26 cerrado?: false (Empresa ID: 3)
2026-01-27 11:05:14 [http-nio-8080-exec-10] WARN  j.s.s.config.CierreDiarioInterceptor - üö´ BLOQUEANDO acceso - D√≠a 2026-01-26 no cerrado. Redirigiendo a /cierres/obligatorio
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 364, Tenant anterior: 3
2026-01-27 11:05:14 [http-nio-8080-exec-10] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 364, Request: /principal, Empresa ID anterior: 3
2026-01-27 11:05:14 [http-nio-8080-exec-1] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres/obligatorio?fecha=2026-01-26
2026-01-27 11:05:14 [http-nio-8080-exec-1] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:05:14 [http-nio-8080-exec-1] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres/obligatorio?fecha=2026-01-26
2026-01-27 11:05:14 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres/obligatorio, M√©todo: GET
2026-01-27 11:05:14 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:14 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:14 [http-nio-8080-exec-1] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:14 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:14 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 355
2026-01-27 11:05:14 [http-nio-8080-exec-1] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:14 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:05:14 [http-nio-8080-exec-1] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:05:14 [http-nio-8080-exec-1] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:14 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:14 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:14 [http-nio-8080-exec-1] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:14 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:14 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:05:14 [http-nio-8080-exec-1] INFO  j.s.s.c.CierreInventarioDiarioControlador - ‚è∞ GET /cierres/obligatorio - Verificando cierre obligatorio
2026-01-27 11:05:14 [http-nio-8080-exec-1] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Hora actual: 11:00, Fecha: 2026-01-27
2026-01-27 11:05:14 [http-nio-8080-exec-1] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Fecha proporcionada: 2026-01-26
2026-01-27 11:05:14 [http-nio-8080-exec-1] INFO  j.s.s.c.CierreInventarioDiarioControlador - ‚ö†Ô∏è Cierre obligatorio requerido para fecha: 2026-01-26
2026-01-27 11:05:14 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 355, Tenant anterior: 3
2026-01-27 11:05:14 [http-nio-8080-exec-1] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 355, Request: /cierres/obligatorio, Empresa ID anterior: 3
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres/iniciar?fecha=2026-01-25
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres/iniciar?fecha=2026-01-25
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres/iniciar, M√©todo: GET
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:31 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 356
2026-01-27 11:05:31 [http-nio-8080-exec-2] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:31 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:31 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:31 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:05:31 [http-nio-8080-exec-2] INFO  j.s.s.c.CierreInventarioDiarioControlador - üöÄ GET /cierres/iniciar - Iniciando nuevo cierre. Usuario: admin, Fecha: 2026-01-25
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:31 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:31 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:31 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:31 [http-nio-8080-exec-2] INFO  j.s.s.s.CierreInventarioDiarioService - Iniciando cierre para fecha espec√≠fica: 2026-01-25 para empresa ID: 3, Usuario: admin
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG o.s.jdbc.datasource.DataSourceUtils - Setting JDBC Connection [HikariProxyConnection@2041118288 wrapping com.mysql.cj.jdbc.ConnectionImpl@6b657c25] read-only
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:31 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG o.s.jdbc.datasource.DataSourceUtils - Resetting read-only flag of JDBC Connection [HikariProxyConnection@2041118288 wrapping com.mysql.cj.jdbc.ConnectionImpl@6b657c25]
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.fecha=? 
        and e1_0.id=?
2026-01-27 11:05:31 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:DATE) <- [2026-01-25]
2026-01-27 11:05:31 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG j.s.s.s.CierreInventarioDiarioService - No hay cierre existente para fecha: 2026-01-25
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    insert 
    into
        cierre_inventario_diario
        (cantidad_facturas, empresa_id, estado, fecha, observaciones, total_ventas, usuario_id) 
    values
        (?, ?, ?, ?, ?, ?, ?)
2026-01-27 11:05:31 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:INTEGER) <- [0]
2026-01-27 11:05:31 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:31 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (3:VARCHAR) <- [EN_PROCESO]
2026-01-27 11:05:31 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (4:DATE) <- [2026-01-25]
2026-01-27 11:05:31 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (5:VARCHAR) <- [Cierre para fecha espec√≠fica 2026-01-25]
2026-01-27 11:05:31 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (6:DOUBLE) <- [0.0]
2026-01-27 11:05:31 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (7:BIGINT) <- [8]
2026-01-27 11:05:31 [http-nio-8080-exec-2] INFO  j.s.s.s.CierreInventarioDiarioService - ‚úÖ Cierre creado para fecha espec√≠fica ID: 7 - Fecha: 2026-01-25, Usuario: admin
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG j.s.s.s.CierreInventarioDiarioService - Precargando detalles para cierre ID: 7
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        i1_0.id,
        i1_0.activo,
        i1_0.empresa_id,
        i1_0.nombre,
        i1_0.precio,
        i1_0.stock_actual,
        i1_0.stock_minimo,
        i1_0.unidad_medida 
    from
        ingrediente i1_0 
    left join
        empresa e1_0 
            on e1_0.id=i1_0.empresa_id 
    where
        e1_0.id=?
2026-01-27 11:05:31 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG j.s.s.s.CierreInventarioDiarioService - Encontrados 0 ingredientes para empresa ID: 3
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        p1_0.id,
        p1_0.activo,
        p1_0.empresa_id,
        p1_0.nombre,
        p1_0.precio_compra,
        p1_0.precio_venta,
        p1_0.receta_id,
        p1_0.stock,
        p1_0.tiene_receta,
        p1_0.unidad_medida_venta 
    from
        producto p1_0 
    left join
        empresa e1_0 
            on e1_0.id=p1_0.empresa_id 
    where
        e1_0.id=? 
        and not(p1_0.tiene_receta)
2026-01-27 11:05:31 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG j.s.s.s.CierreInventarioDiarioService - Encontrados 0 productos sin receta para empresa ID: 3
2026-01-27 11:05:31 [http-nio-8080-exec-2] INFO  j.s.s.s.CierreInventarioDiarioService - Detalles precargados: 0 totales para cierre ID: 7
2026-01-27 11:05:31 [http-nio-8080-exec-2] INFO  j.s.s.c.CierreInventarioDiarioControlador - ‚úÖ Cierre iniciado para fecha espec√≠fica: 2026-01-25 por usuario: admin
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 356, Tenant anterior: 3
2026-01-27 11:05:31 [http-nio-8080-exec-2] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 356, Request: /cierres/iniciar, Empresa ID anterior: 3
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres/en-proceso
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres/en-proceso
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres/en-proceso, M√©todo: GET
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:31 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 357
2026-01-27 11:05:31 [http-nio-8080-exec-3] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:31 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:31 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:31 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:05:31 [http-nio-8080-exec-3] INFO  j.s.s.c.CierreInventarioDiarioControlador - üîç GET /cierres/en-proceso - Viendo cierre en proceso
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG j.s.s.s.CierreInventarioDiarioService - Buscando cierre en proceso para empresa ID: 3
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.estado=? 
        and e1_0.id=?
2026-01-27 11:05:31 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [EN_PROCESO]
2026-01-27 11:05:31 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:31 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:05:31 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG j.s.s.s.CierreInventarioDiarioService - Cierre en proceso encontrado ID: 7 para empresa ID: 3
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG j.s.s.s.CierreInventarioDiarioService - Obteniendo detalles para cierre ID: 7
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG j.s.s.s.CierreInventarioDiarioService - Buscando cierre ID: 7 para empresa ID: 3
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.id=? 
        and e1_0.id=?
2026-01-27 11:05:31 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [7]
2026-01-27 11:05:31 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:31 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:05:31 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        dcid1_0.id,
        dcid1_0.cierre_id,
        dcid1_0.costo_unitario,
        dcid1_0.diferencia,
        dcid1_0.ingrediente_id,
        dcid1_0.producto_id,
        dcid1_0.stock_desperdicio,
        dcid1_0.stock_merma,
        dcid1_0.stock_real,
        dcid1_0.stock_teorico,
        dcid1_0.valor_diferencia 
    from
        detalle_cierre_inventario_diario dcid1_0 
    where
        dcid1_0.cierre_id=?
2026-01-27 11:05:31 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [7]
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG j.s.s.s.CierreInventarioDiarioService - Encontrados 0 detalles para cierre ID: 7
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Cierre en proceso ID: 7, Estado: EN_PROCESO, Detalles: 0, Total diferencia: 0.0
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 357, Tenant anterior: 3
2026-01-27 11:05:31 [http-nio-8080-exec-3] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 357, Request: /cierres/en-proceso, Empresa ID anterior: 3
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG o.s.security.web.FilterChainProxy - Securing POST /cierres/completar/7
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG o.s.security.web.FilterChainProxy - Secured POST /cierres/completar/7
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres/completar/7, M√©todo: POST
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:35 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 358
2026-01-27 11:05:35 [http-nio-8080-exec-4] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:35 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:35 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:35 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:05:35 [http-nio-8080-exec-4] INFO  j.s.s.c.CierreInventarioDiarioControlador - üìù POST /cierres/completar/7 - Completando cierre (PRE-COMPLETADO)
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Recibidos 0 detalles para guardar
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG j.s.s.c.CierreInventarioDiarioControlador - 0 detalles actualizados
2026-01-27 11:05:35 [http-nio-8080-exec-4] INFO  j.s.s.s.CierreInventarioDiarioService - Completando cierre ID: 7 para empresa ID: 3
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.id=? 
        and e1_0.id=?
2026-01-27 11:05:35 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [7]
2026-01-27 11:05:35 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:35 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:05:35 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        dcid1_0.id,
        dcid1_0.cierre_id,
        dcid1_0.costo_unitario,
        dcid1_0.diferencia,
        dcid1_0.ingrediente_id,
        dcid1_0.producto_id,
        dcid1_0.stock_desperdicio,
        dcid1_0.stock_merma,
        dcid1_0.stock_real,
        dcid1_0.stock_teorico,
        dcid1_0.valor_diferencia 
    from
        detalle_cierre_inventario_diario dcid1_0 
    where
        dcid1_0.cierre_id=?
2026-01-27 11:05:35 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [7]
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id,
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        s1_0.nombre,
        s1_0.telefono,
        d1_0.cierre_id,
        d1_0.id,
        d1_0.costo_unitario,
        d1_0.diferencia,
        i1_0.id,
        i1_0.activo,
        i1_0.empresa_id,
        i1_0.nombre,
        i1_0.precio,
        i1_0.stock_actual,
        i1_0.stock_minimo,
        i1_0.unidad_medida,
        p1_0.id,
        p1_0.activo,
        p1_0.empresa_id,
        p1_0.nombre,
        p1_0.precio_compra,
        p1_0.precio_venta,
        p1_0.receta_id,
        p1_0.stock,
        p1_0.tiene_receta,
        p1_0.unidad_medida_venta,
        d1_0.stock_desperdicio,
        d1_0.stock_merma,
        d1_0.stock_real,
        d1_0.stock_teorico,
        d1_0.valor_diferencia 
    from
        cierre_inventario_diario cid1_0 
    join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    join
        usuario u1_0 
            on u1_0.id=cid1_0.usuario_id 
    left join
        empresa e2_0 
            on e2_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        detalle_cierre_inventario_diario d1_0 
            on cid1_0.id=d1_0.cierre_id 
    left join
        ingrediente i1_0 
            on i1_0.id=d1_0.ingrediente_id 
    left join
        producto p1_0 
            on p1_0.id=d1_0.producto_id 
    where
        cid1_0.id=?
2026-01-27 11:05:35 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [7]
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    update
        cierre_inventario_diario 
    set
        cantidad_facturas=?,
        empresa_id=?,
        estado=?,
        fecha=?,
        observaciones=?,
        total_ventas=?,
        usuario_id=? 
    where
        id=?
2026-01-27 11:05:35 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:INTEGER) <- [0]
2026-01-27 11:05:35 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:35 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (3:VARCHAR) <- [PRE-COMPLETADO]
2026-01-27 11:05:35 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (4:DATE) <- [2026-01-25]
2026-01-27 11:05:35 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (5:VARCHAR) <- [Cierre para fecha espec√≠fica 2026-01-25]
2026-01-27 11:05:35 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (6:DOUBLE) <- [0.0]
2026-01-27 11:05:35 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (7:BIGINT) <- [8]
2026-01-27 11:05:35 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (8:BIGINT) <- [7]
2026-01-27 11:05:35 [http-nio-8080-exec-4] INFO  j.s.s.s.CierreInventarioDiarioService - Cierre marcado como PRE-COMPLETADO ID: 7 para empresa ID: 3
2026-01-27 11:05:35 [http-nio-8080-exec-4] INFO  j.s.s.c.CierreInventarioDiarioControlador - ‚úÖ Cierre marcado como PRE-COMPLETADO ID: 7
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 358, Tenant anterior: 3
2026-01-27 11:05:35 [http-nio-8080-exec-4] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 358, Request: /cierres/completar/7, Empresa ID anterior: 3
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres, M√©todo: GET
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:35 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 359
2026-01-27 11:05:35 [http-nio-8080-exec-5] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:35 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:35 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:35 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:05:35 [http-nio-8080-exec-5] INFO  j.s.s.c.CierreInventarioDiarioControlador - üìã GET /cierres - Listando cierres diarios
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG j.s.s.s.CierreInventarioDiarioService - Obteniendo todos los cierres para empresa ID: 3
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        e1_0.id=?
2026-01-27 11:05:35 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:35 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:05:35 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG j.s.s.s.CierreInventarioDiarioService - Encontrados 2 cierres para empresa ID: 3
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Encontrados 2 cierres
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 359, Tenant anterior: 3
2026-01-27 11:05:35 [http-nio-8080-exec-5] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 359, Request: /cierres, Empresa ID anterior: 3
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres/detalle/7
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres/detalle/7
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres/detalle/7, M√©todo: GET
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:39 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 360
2026-01-27 11:05:39 [http-nio-8080-exec-6] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:39 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:39 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:39 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:05:39 [http-nio-8080-exec-6] INFO  j.s.s.c.CierreInventarioDiarioControlador - üëÅÔ∏è GET /cierres/detalle/7 - Viendo detalles de cierre
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG j.s.s.s.CierreInventarioDiarioService - Buscando cierre ID: 7 para empresa ID: 3
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.id=? 
        and e1_0.id=?
2026-01-27 11:05:39 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [7]
2026-01-27 11:05:39 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:39 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:05:39 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG j.s.s.s.CierreInventarioDiarioService - Obteniendo detalles para cierre ID: 7
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG j.s.s.s.CierreInventarioDiarioService - Buscando cierre ID: 7 para empresa ID: 3
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.id=? 
        and e1_0.id=?
2026-01-27 11:05:39 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [7]
2026-01-27 11:05:39 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:39 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:05:39 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        dcid1_0.id,
        dcid1_0.cierre_id,
        dcid1_0.costo_unitario,
        dcid1_0.diferencia,
        dcid1_0.ingrediente_id,
        dcid1_0.producto_id,
        dcid1_0.stock_desperdicio,
        dcid1_0.stock_merma,
        dcid1_0.stock_real,
        dcid1_0.stock_teorico,
        dcid1_0.valor_diferencia 
    from
        detalle_cierre_inventario_diario dcid1_0 
    where
        dcid1_0.cierre_id=?
2026-01-27 11:05:39 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [7]
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG j.s.s.s.CierreInventarioDiarioService - Encontrados 0 detalles para cierre ID: 7
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Cierre ID: 7, Estado: PRE-COMPLETADO, Detalles: 0, Diferencia total: 0.0
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Cierre PRE-COMPLETADO, mostrando vista para editar
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 360, Tenant anterior: 3
2026-01-27 11:05:39 [http-nio-8080-exec-6] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 360, Request: /cierres/detalle/7, Empresa ID anterior: 3
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG o.s.security.web.FilterChainProxy - Securing POST /cierres/completar-definitivo/7
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG o.s.security.web.FilterChainProxy - Secured POST /cierres/completar-definitivo/7
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres/completar-definitivo/7, M√©todo: POST
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 361
2026-01-27 11:05:40 [http-nio-8080-exec-7] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:05:40 [http-nio-8080-exec-7] INFO  j.s.s.c.CierreInventarioDiarioControlador - ‚úÖ POST /cierres/completar-definitivo/7 - Completando cierre definitivamente
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Actualizando 0 detalles antes de completar
2026-01-27 11:05:40 [http-nio-8080-exec-7] INFO  j.s.s.s.CierreInventarioDiarioService - Completando cierre definitivo ID: 7
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG j.s.s.s.CierreInventarioDiarioService - Buscando cierre ID: 7 para empresa ID: 3
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.id=? 
        and e1_0.id=?
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [7]
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG j.s.s.s.CierreInventarioDiarioService - Calculando ventas del d√≠a para cierre ID: 7
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG j.s.s.s.CierreInventarioDiarioService - Calculando ventas del d√≠a 2026-01-25 para empresa ID: 3
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        f1_0.id,
        f1_0.cliente_id,
        f1_0.empresa_id,
        f1_0.estado,
        f1_0.fecha,
        f1_0.forma_pago,
        f1_0.iva,
        f1_0.numero_factura,
        f1_0.subtotal,
        f1_0.total 
    from
        factura f1_0 
    left join
        empresa e1_0 
            on e1_0.id=f1_0.empresa_id 
    where
        f1_0.fecha=? 
        and f1_0.estado=? 
        and e1_0.id=?
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:DATE) <- [2026-01-25]
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:VARCHAR) <- [PAGADA]
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (3:BIGINT) <- [3]
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG j.s.s.s.CierreInventarioDiarioService - Ventas calculadas: 0 facturas, Total: 0.0 para fecha: 2026-01-25
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        dcid1_0.id,
        dcid1_0.cierre_id,
        dcid1_0.costo_unitario,
        dcid1_0.diferencia,
        dcid1_0.ingrediente_id,
        dcid1_0.producto_id,
        dcid1_0.stock_desperdicio,
        dcid1_0.stock_merma,
        dcid1_0.stock_real,
        dcid1_0.stock_teorico,
        dcid1_0.valor_diferencia 
    from
        detalle_cierre_inventario_diario dcid1_0 
    where
        dcid1_0.cierre_id=?
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [7]
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG j.s.s.s.CierreInventarioDiarioService - Ajustando inventario para 0 detalles
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG j.s.s.s.CierreInventarioDiarioService - Ajustando inventario para 0 detalles
2026-01-27 11:05:40 [http-nio-8080-exec-7] INFO  j.s.s.s.CierreInventarioDiarioService - Inventario ajustado: 0 ingredientes, 0 productos
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id,
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        s1_0.nombre,
        s1_0.telefono,
        d1_0.cierre_id,
        d1_0.id,
        d1_0.costo_unitario,
        d1_0.diferencia,
        i1_0.id,
        i1_0.activo,
        i1_0.empresa_id,
        i1_0.nombre,
        i1_0.precio,
        i1_0.stock_actual,
        i1_0.stock_minimo,
        i1_0.unidad_medida,
        p1_0.id,
        p1_0.activo,
        p1_0.empresa_id,
        p1_0.nombre,
        p1_0.precio_compra,
        p1_0.precio_venta,
        p1_0.receta_id,
        p1_0.stock,
        p1_0.tiene_receta,
        p1_0.unidad_medida_venta,
        d1_0.stock_desperdicio,
        d1_0.stock_merma,
        d1_0.stock_real,
        d1_0.stock_teorico,
        d1_0.valor_diferencia 
    from
        cierre_inventario_diario cid1_0 
    join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    join
        usuario u1_0 
            on u1_0.id=cid1_0.usuario_id 
    left join
        empresa e2_0 
            on e2_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        detalle_cierre_inventario_diario d1_0 
            on cid1_0.id=d1_0.cierre_id 
    left join
        ingrediente i1_0 
            on i1_0.id=d1_0.ingrediente_id 
    left join
        producto p1_0 
            on p1_0.id=d1_0.producto_id 
    where
        cid1_0.id=?
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [7]
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    update
        cierre_inventario_diario 
    set
        cantidad_facturas=?,
        empresa_id=?,
        estado=?,
        fecha=?,
        observaciones=?,
        total_ventas=?,
        usuario_id=? 
    where
        id=?
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:INTEGER) <- [0]
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (3:VARCHAR) <- [COMPLETADO]
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (4:DATE) <- [2026-01-25]
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (5:VARCHAR) <- [Cierre para fecha espec√≠fica 2026-01-25]
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (6:DOUBLE) <- [0.0]
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (7:BIGINT) <- [8]
2026-01-27 11:05:40 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (8:BIGINT) <- [7]
2026-01-27 11:05:40 [http-nio-8080-exec-7] INFO  j.s.s.s.CierreInventarioDiarioService - Cierre completado definitivamente ID: 7 para empresa ID: 3. Total ventas: 0.0, Cantidad facturas: 0
2026-01-27 11:05:40 [http-nio-8080-exec-7] INFO  j.s.s.c.CierreInventarioDiarioControlador - ‚úÖ Cierre completado definitivamente ID: 7
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 361, Tenant anterior: 3
2026-01-27 11:05:40 [http-nio-8080-exec-7] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 361, Request: /cierres/completar-definitivo/7, Empresa ID anterior: 3
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres, M√©todo: GET
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:40 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 362
2026-01-27 11:05:40 [http-nio-8080-exec-8] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:40 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:40 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:40 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:05:40 [http-nio-8080-exec-8] INFO  j.s.s.c.CierreInventarioDiarioControlador - üìã GET /cierres - Listando cierres diarios
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG j.s.s.s.CierreInventarioDiarioService - Obteniendo todos los cierres para empresa ID: 3
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        e1_0.id=?
2026-01-27 11:05:40 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:40 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:05:40 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG j.s.s.s.CierreInventarioDiarioService - Encontrados 2 cierres para empresa ID: 3
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Encontrados 2 cierres
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 362, Tenant anterior: 3
2026-01-27 11:05:40 [http-nio-8080-exec-8] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 362, Request: /cierres, Empresa ID anterior: 3
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG o.s.security.web.FilterChainProxy - Securing GET /principal
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG o.s.security.web.FilterChainProxy - Secured GET /principal
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /principal, M√©todo: GET
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:50 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 363
2026-01-27 11:05:50 [http-nio-8080-exec-9] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:50 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:50 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:50 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG j.s.s.config.CierreDiarioInterceptor - üõ°Ô∏è Interceptor ejecutando - Ruta: /principal, Empresa ID: 3
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG j.s.s.config.CierreDiarioInterceptor - üìÖ Validaci√≥n de cierre - Fecha: 2026-01-27, Hora: 11:00
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG org.hibernate.SQL - 
    select
        case 
            when count(cid1_0.id)>0 
                then 1 
            else 0 
    end 
from
    cierre_inventario_diario cid1_0 
where
    cid1_0.fecha=? 
    and cid1_0.estado=? 
    and cid1_0.empresa_id=?
2026-01-27 11:05:50 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:DATE) <- [2026-01-27]
2026-01-27 11:05:50 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:VARCHAR) <- [COMPLETADO]
2026-01-27 11:05:50 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (3:BIGINT) <- [3]
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG j.s.s.config.CierreDiarioInterceptor - ‚úÖ Despu√©s de las 5:00 AM ‚Üí Validar AYER: 2026-01-26
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG org.hibernate.SQL - 
    select
        case 
            when count(cid1_0.id)>0 
                then 1 
            else 0 
    end 
from
    cierre_inventario_diario cid1_0 
where
    cid1_0.fecha=? 
    and cid1_0.estado=? 
    and cid1_0.empresa_id=?
2026-01-27 11:05:50 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:DATE) <- [2026-01-26]
2026-01-27 11:05:50 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:VARCHAR) <- [COMPLETADO]
2026-01-27 11:05:50 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (3:BIGINT) <- [3]
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG j.s.s.config.CierreDiarioInterceptor - ¬øD√≠a 2026-01-26 cerrado?: false (Empresa ID: 3)
2026-01-27 11:05:50 [http-nio-8080-exec-9] WARN  j.s.s.config.CierreDiarioInterceptor - üö´ BLOQUEANDO acceso - D√≠a 2026-01-26 no cerrado. Redirigiendo a /cierres/obligatorio
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 363, Tenant anterior: 3
2026-01-27 11:05:50 [http-nio-8080-exec-9] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 363, Request: /principal, Empresa ID anterior: 3
2026-01-27 11:05:50 [http-nio-8080-exec-10] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres/obligatorio?fecha=2026-01-26
2026-01-27 11:05:50 [http-nio-8080-exec-10] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:05:50 [http-nio-8080-exec-10] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres/obligatorio?fecha=2026-01-26
2026-01-27 11:05:50 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres/obligatorio, M√©todo: GET
2026-01-27 11:05:50 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:50 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:50 [http-nio-8080-exec-10] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:50 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:50 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 364
2026-01-27 11:05:50 [http-nio-8080-exec-10] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:50 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:05:50 [http-nio-8080-exec-10] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:05:50 [http-nio-8080-exec-10] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:50 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:50 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:50 [http-nio-8080-exec-10] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:50 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:50 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:05:50 [http-nio-8080-exec-10] INFO  j.s.s.c.CierreInventarioDiarioControlador - ‚è∞ GET /cierres/obligatorio - Verificando cierre obligatorio
2026-01-27 11:05:50 [http-nio-8080-exec-10] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Hora actual: 11:00, Fecha: 2026-01-27
2026-01-27 11:05:50 [http-nio-8080-exec-10] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Fecha proporcionada: 2026-01-26
2026-01-27 11:05:50 [http-nio-8080-exec-10] INFO  j.s.s.c.CierreInventarioDiarioControlador - ‚ö†Ô∏è Cierre obligatorio requerido para fecha: 2026-01-26
2026-01-27 11:05:50 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 364, Tenant anterior: 3
2026-01-27 11:05:50 [http-nio-8080-exec-10] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 364, Request: /cierres/obligatorio, Empresa ID anterior: 3
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres/iniciar?fecha=2026-01-25
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres/iniciar?fecha=2026-01-25
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres/iniciar, M√©todo: GET
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:54 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 355
2026-01-27 11:05:54 [http-nio-8080-exec-1] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:54 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:54 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:54 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:05:54 [http-nio-8080-exec-1] INFO  j.s.s.c.CierreInventarioDiarioControlador - üöÄ GET /cierres/iniciar - Iniciando nuevo cierre. Usuario: admin, Fecha: 2026-01-25
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:54 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:54 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:54 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:54 [http-nio-8080-exec-1] INFO  j.s.s.s.CierreInventarioDiarioService - Iniciando cierre para fecha espec√≠fica: 2026-01-25 para empresa ID: 3, Usuario: admin
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG o.s.jdbc.datasource.DataSourceUtils - Setting JDBC Connection [HikariProxyConnection@494987103 wrapping com.mysql.cj.jdbc.ConnectionImpl@6b657c25] read-only
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:54 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG o.s.jdbc.datasource.DataSourceUtils - Resetting read-only flag of JDBC Connection [HikariProxyConnection@494987103 wrapping com.mysql.cj.jdbc.ConnectionImpl@6b657c25]
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.fecha=? 
        and e1_0.id=?
2026-01-27 11:05:54 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:DATE) <- [2026-01-25]
2026-01-27 11:05:54 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:54 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:05:54 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:05:54 [http-nio-8080-exec-1] WARN  j.s.s.s.CierreInventarioDiarioService - Ya existe un cierre para la fecha: 2026-01-25 - Estado: COMPLETADO, ID: 7
2026-01-27 11:05:54 [http-nio-8080-exec-1] ERROR j.s.s.c.CierreInventarioDiarioControlador - ‚ùå Error al iniciar cierre. Usuario: admin, Fecha: 2026-01-25, Error: Ya existe un cierre COMPLETADO para la fecha: 2026-01-25
java.lang.RuntimeException: Ya existe un cierre COMPLETADO para la fecha: 2026-01-25
	at jpd.sistemafacinv.sistemadefacturacioneinventario.servicios.CierreInventarioDiarioService.iniciarCierreParaFecha(CierreInventarioDiarioService.java:369) ~[classes/:na]
	at jpd.sistemafacinv.sistemadefacturacioneinventario.controladores.CierreInventarioDiarioControlador.iniciarNuevoCierre(CierreInventarioDiarioControlador.java:62) ~[classes/:na]
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:na]
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77) ~[na:na]
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:na]
	at java.base/java.lang.reflect.Method.invoke(Method.java:569) ~[na:na]
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:258) ~[spring-web-6.2.14.jar:6.2.14]
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:191) ~[spring-web-6.2.14.jar:6.2.14]
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118) ~[spring-webmvc-6.2.14.jar:6.2.14]
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:991) ~[spring-webmvc-6.2.14.jar:6.2.14]
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:896) ~[spring-webmvc-6.2.14.jar:6.2.14]
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87) ~[spring-webmvc-6.2.14.jar:6.2.14]
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089) ~[spring-webmvc-6.2.14.jar:6.2.14]
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979) ~[spring-webmvc-6.2.14.jar:6.2.14]
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014) ~[spring-webmvc-6.2.14.jar:6.2.14]
	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903) ~[spring-webmvc-6.2.14.jar:6.2.14]
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564) ~[tomcat-embed-core-10.1.49.jar:6.0]
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885) ~[spring-webmvc-6.2.14.jar:6.2.14]
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658) ~[tomcat-embed-core-10.1.49.jar:6.0]
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:138) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:51) ~[tomcat-embed-websocket-10.1.49.jar:10.1.49]
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:162) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:138) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at jpd.sistemafacinv.sistemadefacturacioneinventario.context.TenantFilter.doFilter(TenantFilter.java:123) ~[classes/:na]
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:162) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:138) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at jpd.sistemafacinv.sistemadefacturacioneinventario.context.TenantContextCleanupFilter.doFilter(TenantContextCleanupFilter.java:45) ~[classes/:na]
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:162) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:138) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.springframework.web.filter.CompositeFilter$VirtualFilterChain.doFilter(CompositeFilter.java:108) ~[spring-web-6.2.14.jar:6.2.14]
	at org.springframework.web.filter.CompositeFilter$VirtualFilterChain.doFilter(CompositeFilter.java:108) ~[spring-web-6.2.14.jar:6.2.14]
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:365) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:101) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:125) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:119) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter.doFilter(AbstractAuthenticationProcessingFilter.java:235) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter.doFilter(AbstractAuthenticationProcessingFilter.java:229) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.csrf.CsrfFilter.doFilterInternal(CsrfFilter.java:117) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116) ~[spring-web-6.2.14.jar:6.2.14]
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116) ~[spring-web-6.2.14.jar:6.2.14]
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116) ~[spring-web-6.2.14.jar:6.2.14]
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116) ~[spring-web-6.2.14.jar:6.2.14]
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191) ~[spring-security-web-6.5.7.jar:6.5.7]
	at org.springframework.web.filter.CompositeFilter$VirtualFilterChain.doFilter(CompositeFilter.java:113) ~[spring-web-6.2.14.jar:6.2.14]
	at org.springframework.web.filter.ServletRequestPathFilter.doFilter(ServletRequestPathFilter.java:52) ~[spring-web-6.2.14.jar:6.2.14]
	at org.springframework.web.filter.CompositeFilter$VirtualFilterChain.doFilter(CompositeFilter.java:113) ~[spring-web-6.2.14.jar:6.2.14]
	at org.springframework.web.filter.CompositeFilter.doFilter(CompositeFilter.java:74) ~[spring-web-6.2.14.jar:6.2.14]
	at org.springframework.security.config.annotation.web.configuration.WebSecurityConfiguration$CompositeFilterChainProxy.doFilter(WebSecurityConfiguration.java:319) ~[spring-security-config-6.5.7.jar:6.5.7]
	at org.springframework.web.filter.CompositeFilter$VirtualFilterChain.doFilter(CompositeFilter.java:113) ~[spring-web-6.2.14.jar:6.2.14]
	at org.springframework.web.servlet.handler.HandlerMappingIntrospector.lambda$createCacheFilter$4(HandlerMappingIntrospector.java:267) ~[spring-webmvc-6.2.14.jar:6.2.14]
	at org.springframework.web.filter.CompositeFilter$VirtualFilterChain.doFilter(CompositeFilter.java:113) ~[spring-web-6.2.14.jar:6.2.14]
	at org.springframework.web.filter.CompositeFilter.doFilter(CompositeFilter.java:74) ~[spring-web-6.2.14.jar:6.2.14]
	at org.springframework.security.config.annotation.web.configuration.WebMvcSecurityConfiguration$CompositeFilterChainProxy.doFilter(WebMvcSecurityConfiguration.java:240) ~[spring-security-config-6.5.7.jar:6.5.7]
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:362) ~[spring-web-6.2.14.jar:6.2.14]
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:278) ~[spring-web-6.2.14.jar:6.2.14]
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:162) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:138) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100) ~[spring-web-6.2.14.jar:6.2.14]
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116) ~[spring-web-6.2.14.jar:6.2.14]
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:162) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:138) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93) ~[spring-web-6.2.14.jar:6.2.14]
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116) ~[spring-web-6.2.14.jar:6.2.14]
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:162) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:138) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201) ~[spring-web-6.2.14.jar:6.2.14]
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116) ~[spring-web-6.2.14.jar:6.2.14]
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:162) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:138) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101) ~[spring-web-6.2.14.jar:6.2.14]
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:162) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:138) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:165) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:88) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:482) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:113) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:83) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:72) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:342) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:399) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:63) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:903) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1774) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:973) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:491) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:63) ~[tomcat-embed-core-10.1.49.jar:10.1.49]
	at java.base/java.lang.Thread.run(Thread.java:840) ~[na:na]
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 355, Tenant anterior: 3
2026-01-27 11:05:54 [http-nio-8080-exec-1] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 355, Request: /cierres/iniciar, Empresa ID anterior: 3
2026-01-27 11:05:54 [http-nio-8080-exec-2] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres/obligatorio
2026-01-27 11:05:54 [http-nio-8080-exec-2] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:05:54 [http-nio-8080-exec-2] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres/obligatorio
2026-01-27 11:05:54 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres/obligatorio, M√©todo: GET
2026-01-27 11:05:54 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:54 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:54 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:54 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:54 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 356
2026-01-27 11:05:54 [http-nio-8080-exec-2] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:54 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:05:54 [http-nio-8080-exec-2] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:05:54 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:54 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:54 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:54 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:54 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:54 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:05:54 [http-nio-8080-exec-2] INFO  j.s.s.c.CierreInventarioDiarioControlador - ‚è∞ GET /cierres/obligatorio - Verificando cierre obligatorio
2026-01-27 11:05:54 [http-nio-8080-exec-2] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Hora actual: 11:00, Fecha: 2026-01-27
2026-01-27 11:05:54 [http-nio-8080-exec-2] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Despu√©s de 5 AM, fecha pendiente: 2026-01-26 (ayer)
2026-01-27 11:05:54 [http-nio-8080-exec-2] INFO  j.s.s.c.CierreInventarioDiarioControlador - ‚ö†Ô∏è Cierre obligatorio requerido para fecha: 2026-01-26
2026-01-27 11:05:54 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 356, Tenant anterior: 3
2026-01-27 11:05:54 [http-nio-8080-exec-2] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 356, Request: /cierres/obligatorio, Empresa ID anterior: 3
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres/iniciar?fecha=2026-01-26
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres/iniciar?fecha=2026-01-26
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres/iniciar, M√©todo: GET
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:55 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 357
2026-01-27 11:05:55 [http-nio-8080-exec-3] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:55 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:55 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:55 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:05:55 [http-nio-8080-exec-3] INFO  j.s.s.c.CierreInventarioDiarioControlador - üöÄ GET /cierres/iniciar - Iniciando nuevo cierre. Usuario: admin, Fecha: 2026-01-26
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:55 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:55 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:55 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:55 [http-nio-8080-exec-3] INFO  j.s.s.s.CierreInventarioDiarioService - Iniciando cierre para fecha espec√≠fica: 2026-01-26 para empresa ID: 3, Usuario: admin
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG o.s.jdbc.datasource.DataSourceUtils - Setting JDBC Connection [HikariProxyConnection@1593782257 wrapping com.mysql.cj.jdbc.ConnectionImpl@6b657c25] read-only
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:55 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG o.s.jdbc.datasource.DataSourceUtils - Resetting read-only flag of JDBC Connection [HikariProxyConnection@1593782257 wrapping com.mysql.cj.jdbc.ConnectionImpl@6b657c25]
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.fecha=? 
        and e1_0.id=?
2026-01-27 11:05:55 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:DATE) <- [2026-01-26]
2026-01-27 11:05:55 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG j.s.s.s.CierreInventarioDiarioService - No hay cierre existente para fecha: 2026-01-26
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    insert 
    into
        cierre_inventario_diario
        (cantidad_facturas, empresa_id, estado, fecha, observaciones, total_ventas, usuario_id) 
    values
        (?, ?, ?, ?, ?, ?, ?)
2026-01-27 11:05:55 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:INTEGER) <- [0]
2026-01-27 11:05:55 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:55 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (3:VARCHAR) <- [EN_PROCESO]
2026-01-27 11:05:55 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (4:DATE) <- [2026-01-26]
2026-01-27 11:05:55 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (5:VARCHAR) <- [Cierre para fecha espec√≠fica 2026-01-26]
2026-01-27 11:05:55 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (6:DOUBLE) <- [0.0]
2026-01-27 11:05:55 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (7:BIGINT) <- [8]
2026-01-27 11:05:55 [http-nio-8080-exec-3] INFO  j.s.s.s.CierreInventarioDiarioService - ‚úÖ Cierre creado para fecha espec√≠fica ID: 8 - Fecha: 2026-01-26, Usuario: admin
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG j.s.s.s.CierreInventarioDiarioService - Precargando detalles para cierre ID: 8
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        i1_0.id,
        i1_0.activo,
        i1_0.empresa_id,
        i1_0.nombre,
        i1_0.precio,
        i1_0.stock_actual,
        i1_0.stock_minimo,
        i1_0.unidad_medida 
    from
        ingrediente i1_0 
    left join
        empresa e1_0 
            on e1_0.id=i1_0.empresa_id 
    where
        e1_0.id=?
2026-01-27 11:05:55 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG j.s.s.s.CierreInventarioDiarioService - Encontrados 0 ingredientes para empresa ID: 3
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        p1_0.id,
        p1_0.activo,
        p1_0.empresa_id,
        p1_0.nombre,
        p1_0.precio_compra,
        p1_0.precio_venta,
        p1_0.receta_id,
        p1_0.stock,
        p1_0.tiene_receta,
        p1_0.unidad_medida_venta 
    from
        producto p1_0 
    left join
        empresa e1_0 
            on e1_0.id=p1_0.empresa_id 
    where
        e1_0.id=? 
        and not(p1_0.tiene_receta)
2026-01-27 11:05:55 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG j.s.s.s.CierreInventarioDiarioService - Encontrados 0 productos sin receta para empresa ID: 3
2026-01-27 11:05:55 [http-nio-8080-exec-3] INFO  j.s.s.s.CierreInventarioDiarioService - Detalles precargados: 0 totales para cierre ID: 8
2026-01-27 11:05:55 [http-nio-8080-exec-3] INFO  j.s.s.c.CierreInventarioDiarioControlador - ‚úÖ Cierre iniciado para fecha espec√≠fica: 2026-01-26 por usuario: admin
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 357, Tenant anterior: 3
2026-01-27 11:05:55 [http-nio-8080-exec-3] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 357, Request: /cierres/iniciar, Empresa ID anterior: 3
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres/en-proceso
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres/en-proceso
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres/en-proceso, M√©todo: GET
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:55 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 358
2026-01-27 11:05:55 [http-nio-8080-exec-4] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:55 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:55 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:55 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:05:55 [http-nio-8080-exec-4] INFO  j.s.s.c.CierreInventarioDiarioControlador - üîç GET /cierres/en-proceso - Viendo cierre en proceso
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG j.s.s.s.CierreInventarioDiarioService - Buscando cierre en proceso para empresa ID: 3
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.estado=? 
        and e1_0.id=?
2026-01-27 11:05:55 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [EN_PROCESO]
2026-01-27 11:05:55 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:55 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:05:55 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG j.s.s.s.CierreInventarioDiarioService - Cierre en proceso encontrado ID: 8 para empresa ID: 3
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG j.s.s.s.CierreInventarioDiarioService - Obteniendo detalles para cierre ID: 8
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG j.s.s.s.CierreInventarioDiarioService - Buscando cierre ID: 8 para empresa ID: 3
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.id=? 
        and e1_0.id=?
2026-01-27 11:05:55 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:05:55 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:55 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:05:55 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        dcid1_0.id,
        dcid1_0.cierre_id,
        dcid1_0.costo_unitario,
        dcid1_0.diferencia,
        dcid1_0.ingrediente_id,
        dcid1_0.producto_id,
        dcid1_0.stock_desperdicio,
        dcid1_0.stock_merma,
        dcid1_0.stock_real,
        dcid1_0.stock_teorico,
        dcid1_0.valor_diferencia 
    from
        detalle_cierre_inventario_diario dcid1_0 
    where
        dcid1_0.cierre_id=?
2026-01-27 11:05:55 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG j.s.s.s.CierreInventarioDiarioService - Encontrados 0 detalles para cierre ID: 8
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Cierre en proceso ID: 8, Estado: EN_PROCESO, Detalles: 0, Total diferencia: 0.0
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 358, Tenant anterior: 3
2026-01-27 11:05:55 [http-nio-8080-exec-4] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 358, Request: /cierres/en-proceso, Empresa ID anterior: 3
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG o.s.security.web.FilterChainProxy - Securing POST /cierres/completar/8
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG o.s.security.web.FilterChainProxy - Secured POST /cierres/completar/8
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres/completar/8, M√©todo: POST
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:58 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 359
2026-01-27 11:05:58 [http-nio-8080-exec-5] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:58 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:58 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:58 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:05:58 [http-nio-8080-exec-5] INFO  j.s.s.c.CierreInventarioDiarioControlador - üìù POST /cierres/completar/8 - Completando cierre (PRE-COMPLETADO)
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Recibidos 0 detalles para guardar
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG j.s.s.c.CierreInventarioDiarioControlador - 0 detalles actualizados
2026-01-27 11:05:58 [http-nio-8080-exec-5] INFO  j.s.s.s.CierreInventarioDiarioService - Completando cierre ID: 8 para empresa ID: 3
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.id=? 
        and e1_0.id=?
2026-01-27 11:05:58 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:05:58 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:58 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:05:58 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        dcid1_0.id,
        dcid1_0.cierre_id,
        dcid1_0.costo_unitario,
        dcid1_0.diferencia,
        dcid1_0.ingrediente_id,
        dcid1_0.producto_id,
        dcid1_0.stock_desperdicio,
        dcid1_0.stock_merma,
        dcid1_0.stock_real,
        dcid1_0.stock_teorico,
        dcid1_0.valor_diferencia 
    from
        detalle_cierre_inventario_diario dcid1_0 
    where
        dcid1_0.cierre_id=?
2026-01-27 11:05:58 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id,
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        s1_0.nombre,
        s1_0.telefono,
        d1_0.cierre_id,
        d1_0.id,
        d1_0.costo_unitario,
        d1_0.diferencia,
        i1_0.id,
        i1_0.activo,
        i1_0.empresa_id,
        i1_0.nombre,
        i1_0.precio,
        i1_0.stock_actual,
        i1_0.stock_minimo,
        i1_0.unidad_medida,
        p1_0.id,
        p1_0.activo,
        p1_0.empresa_id,
        p1_0.nombre,
        p1_0.precio_compra,
        p1_0.precio_venta,
        p1_0.receta_id,
        p1_0.stock,
        p1_0.tiene_receta,
        p1_0.unidad_medida_venta,
        d1_0.stock_desperdicio,
        d1_0.stock_merma,
        d1_0.stock_real,
        d1_0.stock_teorico,
        d1_0.valor_diferencia 
    from
        cierre_inventario_diario cid1_0 
    join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    join
        usuario u1_0 
            on u1_0.id=cid1_0.usuario_id 
    left join
        empresa e2_0 
            on e2_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        detalle_cierre_inventario_diario d1_0 
            on cid1_0.id=d1_0.cierre_id 
    left join
        ingrediente i1_0 
            on i1_0.id=d1_0.ingrediente_id 
    left join
        producto p1_0 
            on p1_0.id=d1_0.producto_id 
    where
        cid1_0.id=?
2026-01-27 11:05:58 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    update
        cierre_inventario_diario 
    set
        cantidad_facturas=?,
        empresa_id=?,
        estado=?,
        fecha=?,
        observaciones=?,
        total_ventas=?,
        usuario_id=? 
    where
        id=?
2026-01-27 11:05:58 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:INTEGER) <- [0]
2026-01-27 11:05:58 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:58 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (3:VARCHAR) <- [PRE-COMPLETADO]
2026-01-27 11:05:58 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (4:DATE) <- [2026-01-26]
2026-01-27 11:05:58 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (5:VARCHAR) <- [Cierre para fecha espec√≠fica 2026-01-26]
2026-01-27 11:05:58 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (6:DOUBLE) <- [0.0]
2026-01-27 11:05:58 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (7:BIGINT) <- [8]
2026-01-27 11:05:58 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (8:BIGINT) <- [8]
2026-01-27 11:05:58 [http-nio-8080-exec-5] INFO  j.s.s.s.CierreInventarioDiarioService - Cierre marcado como PRE-COMPLETADO ID: 8 para empresa ID: 3
2026-01-27 11:05:58 [http-nio-8080-exec-5] INFO  j.s.s.c.CierreInventarioDiarioControlador - ‚úÖ Cierre marcado como PRE-COMPLETADO ID: 8
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 359, Tenant anterior: 3
2026-01-27 11:05:58 [http-nio-8080-exec-5] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 359, Request: /cierres/completar/8, Empresa ID anterior: 3
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres, M√©todo: GET
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:05:58 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 360
2026-01-27 11:05:58 [http-nio-8080-exec-6] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:05:58 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:05:58 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:58 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:05:58 [http-nio-8080-exec-6] INFO  j.s.s.c.CierreInventarioDiarioControlador - üìã GET /cierres - Listando cierres diarios
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG j.s.s.s.CierreInventarioDiarioService - Obteniendo todos los cierres para empresa ID: 3
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        e1_0.id=?
2026-01-27 11:05:58 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:05:58 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:05:58 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG j.s.s.s.CierreInventarioDiarioService - Encontrados 3 cierres para empresa ID: 3
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Encontrados 3 cierres
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 360, Tenant anterior: 3
2026-01-27 11:05:58 [http-nio-8080-exec-6] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 360, Request: /cierres, Empresa ID anterior: 3
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres/detalle/8
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres/detalle/8
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres/detalle/8, M√©todo: GET
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:06:01 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 361
2026-01-27 11:06:01 [http-nio-8080-exec-7] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:06:01 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:06:01 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:01 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:06:01 [http-nio-8080-exec-7] INFO  j.s.s.c.CierreInventarioDiarioControlador - üëÅÔ∏è GET /cierres/detalle/8 - Viendo detalles de cierre
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG j.s.s.s.CierreInventarioDiarioService - Buscando cierre ID: 8 para empresa ID: 3
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.id=? 
        and e1_0.id=?
2026-01-27 11:06:01 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:06:01 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:01 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:06:01 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG j.s.s.s.CierreInventarioDiarioService - Obteniendo detalles para cierre ID: 8
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG j.s.s.s.CierreInventarioDiarioService - Buscando cierre ID: 8 para empresa ID: 3
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.id=? 
        and e1_0.id=?
2026-01-27 11:06:01 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:06:01 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:01 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:06:01 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        dcid1_0.id,
        dcid1_0.cierre_id,
        dcid1_0.costo_unitario,
        dcid1_0.diferencia,
        dcid1_0.ingrediente_id,
        dcid1_0.producto_id,
        dcid1_0.stock_desperdicio,
        dcid1_0.stock_merma,
        dcid1_0.stock_real,
        dcid1_0.stock_teorico,
        dcid1_0.valor_diferencia 
    from
        detalle_cierre_inventario_diario dcid1_0 
    where
        dcid1_0.cierre_id=?
2026-01-27 11:06:01 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG j.s.s.s.CierreInventarioDiarioService - Encontrados 0 detalles para cierre ID: 8
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Cierre ID: 8, Estado: PRE-COMPLETADO, Detalles: 0, Diferencia total: 0.0
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Cierre PRE-COMPLETADO, mostrando vista para editar
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 361, Tenant anterior: 3
2026-01-27 11:06:01 [http-nio-8080-exec-7] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 361, Request: /cierres/detalle/8, Empresa ID anterior: 3
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG o.s.security.web.FilterChainProxy - Securing POST /cierres/completar-definitivo/8
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG o.s.security.web.FilterChainProxy - Secured POST /cierres/completar-definitivo/8
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres/completar-definitivo/8, M√©todo: POST
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 362
2026-01-27 11:06:02 [http-nio-8080-exec-8] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:06:02 [http-nio-8080-exec-8] INFO  j.s.s.c.CierreInventarioDiarioControlador - ‚úÖ POST /cierres/completar-definitivo/8 - Completando cierre definitivamente
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Actualizando 0 detalles antes de completar
2026-01-27 11:06:02 [http-nio-8080-exec-8] INFO  j.s.s.s.CierreInventarioDiarioService - Completando cierre definitivo ID: 8
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG j.s.s.s.CierreInventarioDiarioService - Buscando cierre ID: 8 para empresa ID: 3
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.id=? 
        and e1_0.id=?
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG j.s.s.s.CierreInventarioDiarioService - Calculando ventas del d√≠a para cierre ID: 8
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG j.s.s.s.CierreInventarioDiarioService - Calculando ventas del d√≠a 2026-01-26 para empresa ID: 3
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        f1_0.id,
        f1_0.cliente_id,
        f1_0.empresa_id,
        f1_0.estado,
        f1_0.fecha,
        f1_0.forma_pago,
        f1_0.iva,
        f1_0.numero_factura,
        f1_0.subtotal,
        f1_0.total 
    from
        factura f1_0 
    left join
        empresa e1_0 
            on e1_0.id=f1_0.empresa_id 
    where
        f1_0.fecha=? 
        and f1_0.estado=? 
        and e1_0.id=?
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:DATE) <- [2026-01-26]
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:VARCHAR) <- [PAGADA]
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (3:BIGINT) <- [3]
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG j.s.s.s.CierreInventarioDiarioService - Ventas calculadas: 0 facturas, Total: 0.0 para fecha: 2026-01-26
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        dcid1_0.id,
        dcid1_0.cierre_id,
        dcid1_0.costo_unitario,
        dcid1_0.diferencia,
        dcid1_0.ingrediente_id,
        dcid1_0.producto_id,
        dcid1_0.stock_desperdicio,
        dcid1_0.stock_merma,
        dcid1_0.stock_real,
        dcid1_0.stock_teorico,
        dcid1_0.valor_diferencia 
    from
        detalle_cierre_inventario_diario dcid1_0 
    where
        dcid1_0.cierre_id=?
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG j.s.s.s.CierreInventarioDiarioService - Ajustando inventario para 0 detalles
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG j.s.s.s.CierreInventarioDiarioService - Ajustando inventario para 0 detalles
2026-01-27 11:06:02 [http-nio-8080-exec-8] INFO  j.s.s.s.CierreInventarioDiarioService - Inventario ajustado: 0 ingredientes, 0 productos
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id,
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        s1_0.nombre,
        s1_0.telefono,
        d1_0.cierre_id,
        d1_0.id,
        d1_0.costo_unitario,
        d1_0.diferencia,
        i1_0.id,
        i1_0.activo,
        i1_0.empresa_id,
        i1_0.nombre,
        i1_0.precio,
        i1_0.stock_actual,
        i1_0.stock_minimo,
        i1_0.unidad_medida,
        p1_0.id,
        p1_0.activo,
        p1_0.empresa_id,
        p1_0.nombre,
        p1_0.precio_compra,
        p1_0.precio_venta,
        p1_0.receta_id,
        p1_0.stock,
        p1_0.tiene_receta,
        p1_0.unidad_medida_venta,
        d1_0.stock_desperdicio,
        d1_0.stock_merma,
        d1_0.stock_real,
        d1_0.stock_teorico,
        d1_0.valor_diferencia 
    from
        cierre_inventario_diario cid1_0 
    join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    join
        usuario u1_0 
            on u1_0.id=cid1_0.usuario_id 
    left join
        empresa e2_0 
            on e2_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        detalle_cierre_inventario_diario d1_0 
            on cid1_0.id=d1_0.cierre_id 
    left join
        ingrediente i1_0 
            on i1_0.id=d1_0.ingrediente_id 
    left join
        producto p1_0 
            on p1_0.id=d1_0.producto_id 
    where
        cid1_0.id=?
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    update
        cierre_inventario_diario 
    set
        cantidad_facturas=?,
        empresa_id=?,
        estado=?,
        fecha=?,
        observaciones=?,
        total_ventas=?,
        usuario_id=? 
    where
        id=?
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:INTEGER) <- [0]
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (3:VARCHAR) <- [COMPLETADO]
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (4:DATE) <- [2026-01-26]
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (5:VARCHAR) <- [Cierre para fecha espec√≠fica 2026-01-26]
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (6:DOUBLE) <- [0.0]
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (7:BIGINT) <- [8]
2026-01-27 11:06:02 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (8:BIGINT) <- [8]
2026-01-27 11:06:02 [http-nio-8080-exec-8] INFO  j.s.s.s.CierreInventarioDiarioService - Cierre completado definitivamente ID: 8 para empresa ID: 3. Total ventas: 0.0, Cantidad facturas: 0
2026-01-27 11:06:02 [http-nio-8080-exec-8] INFO  j.s.s.c.CierreInventarioDiarioControlador - ‚úÖ Cierre completado definitivamente ID: 8
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 362, Tenant anterior: 3
2026-01-27 11:06:02 [http-nio-8080-exec-8] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 362, Request: /cierres/completar-definitivo/8, Empresa ID anterior: 3
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres, M√©todo: GET
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:06:02 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 363
2026-01-27 11:06:02 [http-nio-8080-exec-9] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:06:02 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:06:02 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:02 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:06:02 [http-nio-8080-exec-9] INFO  j.s.s.c.CierreInventarioDiarioControlador - üìã GET /cierres - Listando cierres diarios
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG j.s.s.s.CierreInventarioDiarioService - Obteniendo todos los cierres para empresa ID: 3
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        e1_0.id=?
2026-01-27 11:06:02 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:02 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:06:02 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG j.s.s.s.CierreInventarioDiarioService - Encontrados 3 cierres para empresa ID: 3
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Encontrados 3 cierres
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 363, Tenant anterior: 3
2026-01-27 11:06:02 [http-nio-8080-exec-9] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 363, Request: /cierres, Empresa ID anterior: 3
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG o.s.security.web.FilterChainProxy - Securing GET /principal
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG o.s.security.web.FilterChainProxy - Secured GET /principal
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /principal, M√©todo: GET
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:06:08 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 364
2026-01-27 11:06:08 [http-nio-8080-exec-10] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:06:08 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:06:08 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:08 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG j.s.s.config.CierreDiarioInterceptor - üõ°Ô∏è Interceptor ejecutando - Ruta: /principal, Empresa ID: 3
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG j.s.s.config.CierreDiarioInterceptor - üìÖ Validaci√≥n de cierre - Fecha: 2026-01-27, Hora: 11:00
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG org.hibernate.SQL - 
    select
        case 
            when count(cid1_0.id)>0 
                then 1 
            else 0 
    end 
from
    cierre_inventario_diario cid1_0 
where
    cid1_0.fecha=? 
    and cid1_0.estado=? 
    and cid1_0.empresa_id=?
2026-01-27 11:06:08 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:DATE) <- [2026-01-27]
2026-01-27 11:06:08 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:VARCHAR) <- [COMPLETADO]
2026-01-27 11:06:08 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (3:BIGINT) <- [3]
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG j.s.s.config.CierreDiarioInterceptor - ‚úÖ Despu√©s de las 5:00 AM ‚Üí Validar AYER: 2026-01-26
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG org.hibernate.SQL - 
    select
        case 
            when count(cid1_0.id)>0 
                then 1 
            else 0 
    end 
from
    cierre_inventario_diario cid1_0 
where
    cid1_0.fecha=? 
    and cid1_0.estado=? 
    and cid1_0.empresa_id=?
2026-01-27 11:06:08 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:DATE) <- [2026-01-26]
2026-01-27 11:06:08 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:VARCHAR) <- [COMPLETADO]
2026-01-27 11:06:08 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (3:BIGINT) <- [3]
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG j.s.s.config.CierreDiarioInterceptor - ¬øD√≠a 2026-01-26 cerrado?: true (Empresa ID: 3)
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG j.s.s.config.CierreDiarioInterceptor - ‚úÖ Acceso permitido - D√≠a 2026-01-26 cerrado correctamente
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG j.s.s.c.DashboardControlador - üìÖ Agregando estado del d√≠a: 2026-01-27
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    where
        cid1_0.fecha=? 
        and cid1_0.estado='COMPLETADO'
2026-01-27 11:06:08 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:DATE) <- [2026-01-27]
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG j.s.s.c.DashboardControlador - No hay cierre completado para hoy: 2026-01-27
2026-01-27 11:06:08 [http-nio-8080-exec-10] INFO  j.s.s.c.DashboardControlador - üè† GET /principal - Accediendo al dashboard principal
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG j.s.s.c.DashboardControlador - üîç Empresa ID actual: 3
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG o.s.jdbc.datasource.DataSourceUtils - Setting JDBC Connection [HikariProxyConnection@1108130096 wrapping com.mysql.cj.jdbc.ConnectionImpl@6b657c25] read-only
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:08 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG o.s.jdbc.datasource.DataSourceUtils - Resetting read-only flag of JDBC Connection [HikariProxyConnection@1108130096 wrapping com.mysql.cj.jdbc.ConnectionImpl@6b657c25]
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG j.s.s.c.DashboardControlador - üè¢ Datos empresa cargados: Las Empanadas (empanadas)
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 364, Tenant anterior: 3
2026-01-27 11:06:08 [http-nio-8080-exec-10] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 364, Request: /principal, Empresa ID anterior: 3
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres, M√©todo: GET
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:06:13 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 355
2026-01-27 11:06:13 [http-nio-8080-exec-1] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:06:13 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:06:13 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:13 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:06:13 [http-nio-8080-exec-1] INFO  j.s.s.c.CierreInventarioDiarioControlador - üìã GET /cierres - Listando cierres diarios
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG j.s.s.s.CierreInventarioDiarioService - Obteniendo todos los cierres para empresa ID: 3
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        e1_0.id=?
2026-01-27 11:06:13 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:13 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:06:13 [http-nio-8080-exec-1] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG j.s.s.s.CierreInventarioDiarioService - Encontrados 3 cierres para empresa ID: 3
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Encontrados 3 cierres
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 355, Tenant anterior: 3
2026-01-27 11:06:13 [http-nio-8080-exec-1] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 355, Request: /cierres, Empresa ID anterior: 3
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres/iniciar?fecha=2026-01-27
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres/iniciar?fecha=2026-01-27
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres/iniciar, M√©todo: GET
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:06:32 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 356
2026-01-27 11:06:32 [http-nio-8080-exec-2] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:06:32 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:06:32 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:32 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:06:32 [http-nio-8080-exec-2] INFO  j.s.s.c.CierreInventarioDiarioControlador - üöÄ GET /cierres/iniciar - Iniciando nuevo cierre. Usuario: admin, Fecha: 2026-01-27
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:06:32 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:06:32 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:32 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:32 [http-nio-8080-exec-2] INFO  j.s.s.s.CierreInventarioDiarioService - Iniciando cierre para fecha espec√≠fica: 2026-01-27 para empresa ID: 3, Usuario: admin
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG o.s.jdbc.datasource.DataSourceUtils - Setting JDBC Connection [HikariProxyConnection@726703612 wrapping com.mysql.cj.jdbc.ConnectionImpl@6b657c25] read-only
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:32 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG o.s.jdbc.datasource.DataSourceUtils - Resetting read-only flag of JDBC Connection [HikariProxyConnection@726703612 wrapping com.mysql.cj.jdbc.ConnectionImpl@6b657c25]
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.fecha=? 
        and e1_0.id=?
2026-01-27 11:06:32 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:DATE) <- [2026-01-27]
2026-01-27 11:06:32 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG j.s.s.s.CierreInventarioDiarioService - No hay cierre existente para fecha: 2026-01-27
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    insert 
    into
        cierre_inventario_diario
        (cantidad_facturas, empresa_id, estado, fecha, observaciones, total_ventas, usuario_id) 
    values
        (?, ?, ?, ?, ?, ?, ?)
2026-01-27 11:06:32 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:INTEGER) <- [0]
2026-01-27 11:06:32 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:32 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (3:VARCHAR) <- [EN_PROCESO]
2026-01-27 11:06:32 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (4:DATE) <- [2026-01-27]
2026-01-27 11:06:32 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (5:VARCHAR) <- [Cierre para fecha espec√≠fica 2026-01-27]
2026-01-27 11:06:32 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (6:DOUBLE) <- [0.0]
2026-01-27 11:06:32 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (7:BIGINT) <- [8]
2026-01-27 11:06:32 [http-nio-8080-exec-2] INFO  j.s.s.s.CierreInventarioDiarioService - ‚úÖ Cierre creado para fecha espec√≠fica ID: 9 - Fecha: 2026-01-27, Usuario: admin
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG j.s.s.s.CierreInventarioDiarioService - Precargando detalles para cierre ID: 9
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        i1_0.id,
        i1_0.activo,
        i1_0.empresa_id,
        i1_0.nombre,
        i1_0.precio,
        i1_0.stock_actual,
        i1_0.stock_minimo,
        i1_0.unidad_medida 
    from
        ingrediente i1_0 
    left join
        empresa e1_0 
            on e1_0.id=i1_0.empresa_id 
    where
        e1_0.id=?
2026-01-27 11:06:32 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG j.s.s.s.CierreInventarioDiarioService - Encontrados 0 ingredientes para empresa ID: 3
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG org.hibernate.SQL - 
    select
        p1_0.id,
        p1_0.activo,
        p1_0.empresa_id,
        p1_0.nombre,
        p1_0.precio_compra,
        p1_0.precio_venta,
        p1_0.receta_id,
        p1_0.stock,
        p1_0.tiene_receta,
        p1_0.unidad_medida_venta 
    from
        producto p1_0 
    left join
        empresa e1_0 
            on e1_0.id=p1_0.empresa_id 
    where
        e1_0.id=? 
        and not(p1_0.tiene_receta)
2026-01-27 11:06:32 [http-nio-8080-exec-2] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG j.s.s.s.CierreInventarioDiarioService - Encontrados 0 productos sin receta para empresa ID: 3
2026-01-27 11:06:32 [http-nio-8080-exec-2] INFO  j.s.s.s.CierreInventarioDiarioService - Detalles precargados: 0 totales para cierre ID: 9
2026-01-27 11:06:32 [http-nio-8080-exec-2] INFO  j.s.s.c.CierreInventarioDiarioControlador - ‚úÖ Cierre iniciado para fecha espec√≠fica: 2026-01-27 por usuario: admin
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 356, Tenant anterior: 3
2026-01-27 11:06:32 [http-nio-8080-exec-2] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 356, Request: /cierres/iniciar, Empresa ID anterior: 3
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres/en-proceso
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres/en-proceso
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres/en-proceso, M√©todo: GET
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:06:32 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 357
2026-01-27 11:06:32 [http-nio-8080-exec-3] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:06:32 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:06:32 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:32 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:06:32 [http-nio-8080-exec-3] INFO  j.s.s.c.CierreInventarioDiarioControlador - üîç GET /cierres/en-proceso - Viendo cierre en proceso
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG j.s.s.s.CierreInventarioDiarioService - Buscando cierre en proceso para empresa ID: 3
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.estado=? 
        and e1_0.id=?
2026-01-27 11:06:32 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [EN_PROCESO]
2026-01-27 11:06:32 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:32 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:06:32 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG j.s.s.s.CierreInventarioDiarioService - Cierre en proceso encontrado ID: 9 para empresa ID: 3
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG j.s.s.s.CierreInventarioDiarioService - Obteniendo detalles para cierre ID: 9
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG j.s.s.s.CierreInventarioDiarioService - Buscando cierre ID: 9 para empresa ID: 3
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.id=? 
        and e1_0.id=?
2026-01-27 11:06:32 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [9]
2026-01-27 11:06:32 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:32 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:06:32 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG org.hibernate.SQL - 
    select
        dcid1_0.id,
        dcid1_0.cierre_id,
        dcid1_0.costo_unitario,
        dcid1_0.diferencia,
        dcid1_0.ingrediente_id,
        dcid1_0.producto_id,
        dcid1_0.stock_desperdicio,
        dcid1_0.stock_merma,
        dcid1_0.stock_real,
        dcid1_0.stock_teorico,
        dcid1_0.valor_diferencia 
    from
        detalle_cierre_inventario_diario dcid1_0 
    where
        dcid1_0.cierre_id=?
2026-01-27 11:06:32 [http-nio-8080-exec-3] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [9]
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG j.s.s.s.CierreInventarioDiarioService - Encontrados 0 detalles para cierre ID: 9
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Cierre en proceso ID: 9, Estado: EN_PROCESO, Detalles: 0, Total diferencia: 0.0
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 357, Tenant anterior: 3
2026-01-27 11:06:32 [http-nio-8080-exec-3] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 357, Request: /cierres/en-proceso, Empresa ID anterior: 3
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG o.s.security.web.FilterChainProxy - Securing POST /cierres/completar/9
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG o.s.security.web.FilterChainProxy - Secured POST /cierres/completar/9
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres/completar/9, M√©todo: POST
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:06:34 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 358
2026-01-27 11:06:34 [http-nio-8080-exec-4] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:06:34 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:06:34 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:34 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:06:34 [http-nio-8080-exec-4] INFO  j.s.s.c.CierreInventarioDiarioControlador - üìù POST /cierres/completar/9 - Completando cierre (PRE-COMPLETADO)
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Recibidos 0 detalles para guardar
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG j.s.s.c.CierreInventarioDiarioControlador - 0 detalles actualizados
2026-01-27 11:06:34 [http-nio-8080-exec-4] INFO  j.s.s.s.CierreInventarioDiarioService - Completando cierre ID: 9 para empresa ID: 3
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.id=? 
        and e1_0.id=?
2026-01-27 11:06:34 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [9]
2026-01-27 11:06:34 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:34 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:06:34 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        dcid1_0.id,
        dcid1_0.cierre_id,
        dcid1_0.costo_unitario,
        dcid1_0.diferencia,
        dcid1_0.ingrediente_id,
        dcid1_0.producto_id,
        dcid1_0.stock_desperdicio,
        dcid1_0.stock_merma,
        dcid1_0.stock_real,
        dcid1_0.stock_teorico,
        dcid1_0.valor_diferencia 
    from
        detalle_cierre_inventario_diario dcid1_0 
    where
        dcid1_0.cierre_id=?
2026-01-27 11:06:34 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [9]
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id,
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        s1_0.nombre,
        s1_0.telefono,
        d1_0.cierre_id,
        d1_0.id,
        d1_0.costo_unitario,
        d1_0.diferencia,
        i1_0.id,
        i1_0.activo,
        i1_0.empresa_id,
        i1_0.nombre,
        i1_0.precio,
        i1_0.stock_actual,
        i1_0.stock_minimo,
        i1_0.unidad_medida,
        p1_0.id,
        p1_0.activo,
        p1_0.empresa_id,
        p1_0.nombre,
        p1_0.precio_compra,
        p1_0.precio_venta,
        p1_0.receta_id,
        p1_0.stock,
        p1_0.tiene_receta,
        p1_0.unidad_medida_venta,
        d1_0.stock_desperdicio,
        d1_0.stock_merma,
        d1_0.stock_real,
        d1_0.stock_teorico,
        d1_0.valor_diferencia 
    from
        cierre_inventario_diario cid1_0 
    join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    join
        usuario u1_0 
            on u1_0.id=cid1_0.usuario_id 
    left join
        empresa e2_0 
            on e2_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        detalle_cierre_inventario_diario d1_0 
            on cid1_0.id=d1_0.cierre_id 
    left join
        ingrediente i1_0 
            on i1_0.id=d1_0.ingrediente_id 
    left join
        producto p1_0 
            on p1_0.id=d1_0.producto_id 
    where
        cid1_0.id=?
2026-01-27 11:06:34 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [9]
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG org.hibernate.SQL - 
    update
        cierre_inventario_diario 
    set
        cantidad_facturas=?,
        empresa_id=?,
        estado=?,
        fecha=?,
        observaciones=?,
        total_ventas=?,
        usuario_id=? 
    where
        id=?
2026-01-27 11:06:34 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:INTEGER) <- [0]
2026-01-27 11:06:34 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:34 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (3:VARCHAR) <- [PRE-COMPLETADO]
2026-01-27 11:06:34 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (4:DATE) <- [2026-01-27]
2026-01-27 11:06:34 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (5:VARCHAR) <- [Cierre para fecha espec√≠fica 2026-01-27]
2026-01-27 11:06:34 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (6:DOUBLE) <- [0.0]
2026-01-27 11:06:34 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (7:BIGINT) <- [8]
2026-01-27 11:06:34 [http-nio-8080-exec-4] TRACE org.hibernate.orm.jdbc.bind - binding parameter (8:BIGINT) <- [9]
2026-01-27 11:06:34 [http-nio-8080-exec-4] INFO  j.s.s.s.CierreInventarioDiarioService - Cierre marcado como PRE-COMPLETADO ID: 9 para empresa ID: 3
2026-01-27 11:06:34 [http-nio-8080-exec-4] INFO  j.s.s.c.CierreInventarioDiarioControlador - ‚úÖ Cierre marcado como PRE-COMPLETADO ID: 9
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 358, Tenant anterior: 3
2026-01-27 11:06:34 [http-nio-8080-exec-4] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 358, Request: /cierres/completar/9, Empresa ID anterior: 3
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres, M√©todo: GET
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:06:34 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 359
2026-01-27 11:06:34 [http-nio-8080-exec-5] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:06:34 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:06:34 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:34 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:06:34 [http-nio-8080-exec-5] INFO  j.s.s.c.CierreInventarioDiarioControlador - üìã GET /cierres - Listando cierres diarios
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG j.s.s.s.CierreInventarioDiarioService - Obteniendo todos los cierres para empresa ID: 3
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        e1_0.id=?
2026-01-27 11:06:34 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:34 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:06:34 [http-nio-8080-exec-5] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG j.s.s.s.CierreInventarioDiarioService - Encontrados 4 cierres para empresa ID: 3
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Encontrados 4 cierres
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 359, Tenant anterior: 3
2026-01-27 11:06:34 [http-nio-8080-exec-5] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 359, Request: /cierres, Empresa ID anterior: 3
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres/detalle/9
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres/detalle/9
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres/detalle/9, M√©todo: GET
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:06:37 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 360
2026-01-27 11:06:37 [http-nio-8080-exec-6] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:06:37 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:06:37 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:37 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:06:37 [http-nio-8080-exec-6] INFO  j.s.s.c.CierreInventarioDiarioControlador - üëÅÔ∏è GET /cierres/detalle/9 - Viendo detalles de cierre
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG j.s.s.s.CierreInventarioDiarioService - Buscando cierre ID: 9 para empresa ID: 3
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.id=? 
        and e1_0.id=?
2026-01-27 11:06:37 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [9]
2026-01-27 11:06:37 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:37 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:06:37 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG j.s.s.s.CierreInventarioDiarioService - Obteniendo detalles para cierre ID: 9
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG j.s.s.s.CierreInventarioDiarioService - Buscando cierre ID: 9 para empresa ID: 3
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.id=? 
        and e1_0.id=?
2026-01-27 11:06:37 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [9]
2026-01-27 11:06:37 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:37 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:06:37 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG org.hibernate.SQL - 
    select
        dcid1_0.id,
        dcid1_0.cierre_id,
        dcid1_0.costo_unitario,
        dcid1_0.diferencia,
        dcid1_0.ingrediente_id,
        dcid1_0.producto_id,
        dcid1_0.stock_desperdicio,
        dcid1_0.stock_merma,
        dcid1_0.stock_real,
        dcid1_0.stock_teorico,
        dcid1_0.valor_diferencia 
    from
        detalle_cierre_inventario_diario dcid1_0 
    where
        dcid1_0.cierre_id=?
2026-01-27 11:06:37 [http-nio-8080-exec-6] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [9]
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG j.s.s.s.CierreInventarioDiarioService - Encontrados 0 detalles para cierre ID: 9
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Cierre ID: 9, Estado: PRE-COMPLETADO, Detalles: 0, Diferencia total: 0.0
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Cierre PRE-COMPLETADO, mostrando vista para editar
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 360, Tenant anterior: 3
2026-01-27 11:06:37 [http-nio-8080-exec-6] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 360, Request: /cierres/detalle/9, Empresa ID anterior: 3
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG o.s.security.web.FilterChainProxy - Securing POST /cierres/completar-definitivo/9
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG o.s.security.web.FilterChainProxy - Secured POST /cierres/completar-definitivo/9
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres/completar-definitivo/9, M√©todo: POST
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 361
2026-01-27 11:06:37 [http-nio-8080-exec-7] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:06:37 [http-nio-8080-exec-7] INFO  j.s.s.c.CierreInventarioDiarioControlador - ‚úÖ POST /cierres/completar-definitivo/9 - Completando cierre definitivamente
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Actualizando 0 detalles antes de completar
2026-01-27 11:06:37 [http-nio-8080-exec-7] INFO  j.s.s.s.CierreInventarioDiarioService - Completando cierre definitivo ID: 9
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG j.s.s.s.CierreInventarioDiarioService - Buscando cierre ID: 9 para empresa ID: 3
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        cid1_0.id=? 
        and e1_0.id=?
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [9]
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG j.s.s.s.CierreInventarioDiarioService - Calculando ventas del d√≠a para cierre ID: 9
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG j.s.s.s.CierreInventarioDiarioService - Calculando ventas del d√≠a 2026-01-27 para empresa ID: 3
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        f1_0.id,
        f1_0.cliente_id,
        f1_0.empresa_id,
        f1_0.estado,
        f1_0.fecha,
        f1_0.forma_pago,
        f1_0.iva,
        f1_0.numero_factura,
        f1_0.subtotal,
        f1_0.total 
    from
        factura f1_0 
    left join
        empresa e1_0 
            on e1_0.id=f1_0.empresa_id 
    where
        f1_0.fecha=? 
        and f1_0.estado=? 
        and e1_0.id=?
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:DATE) <- [2026-01-27]
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:VARCHAR) <- [PAGADA]
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (3:BIGINT) <- [3]
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG j.s.s.s.CierreInventarioDiarioService - Ventas calculadas: 0 facturas, Total: 0.0 para fecha: 2026-01-27
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        dcid1_0.id,
        dcid1_0.cierre_id,
        dcid1_0.costo_unitario,
        dcid1_0.diferencia,
        dcid1_0.ingrediente_id,
        dcid1_0.producto_id,
        dcid1_0.stock_desperdicio,
        dcid1_0.stock_merma,
        dcid1_0.stock_real,
        dcid1_0.stock_teorico,
        dcid1_0.valor_diferencia 
    from
        detalle_cierre_inventario_diario dcid1_0 
    where
        dcid1_0.cierre_id=?
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [9]
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG j.s.s.s.CierreInventarioDiarioService - Ajustando inventario para 0 detalles
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG j.s.s.s.CierreInventarioDiarioService - Ajustando inventario para 0 detalles
2026-01-27 11:06:37 [http-nio-8080-exec-7] INFO  j.s.s.s.CierreInventarioDiarioService - Inventario ajustado: 0 ingredientes, 0 productos
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id,
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        s1_0.nombre,
        s1_0.telefono,
        d1_0.cierre_id,
        d1_0.id,
        d1_0.costo_unitario,
        d1_0.diferencia,
        i1_0.id,
        i1_0.activo,
        i1_0.empresa_id,
        i1_0.nombre,
        i1_0.precio,
        i1_0.stock_actual,
        i1_0.stock_minimo,
        i1_0.unidad_medida,
        p1_0.id,
        p1_0.activo,
        p1_0.empresa_id,
        p1_0.nombre,
        p1_0.precio_compra,
        p1_0.precio_venta,
        p1_0.receta_id,
        p1_0.stock,
        p1_0.tiene_receta,
        p1_0.unidad_medida_venta,
        d1_0.stock_desperdicio,
        d1_0.stock_merma,
        d1_0.stock_real,
        d1_0.stock_teorico,
        d1_0.valor_diferencia 
    from
        cierre_inventario_diario cid1_0 
    join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    join
        usuario u1_0 
            on u1_0.id=cid1_0.usuario_id 
    left join
        empresa e2_0 
            on e2_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        detalle_cierre_inventario_diario d1_0 
            on cid1_0.id=d1_0.cierre_id 
    left join
        ingrediente i1_0 
            on i1_0.id=d1_0.ingrediente_id 
    left join
        producto p1_0 
            on p1_0.id=d1_0.producto_id 
    where
        cid1_0.id=?
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [9]
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG org.hibernate.SQL - 
    update
        cierre_inventario_diario 
    set
        cantidad_facturas=?,
        empresa_id=?,
        estado=?,
        fecha=?,
        observaciones=?,
        total_ventas=?,
        usuario_id=? 
    where
        id=?
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:INTEGER) <- [0]
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (3:VARCHAR) <- [COMPLETADO]
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (4:DATE) <- [2026-01-27]
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (5:VARCHAR) <- [Cierre para fecha espec√≠fica 2026-01-27]
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (6:DOUBLE) <- [0.0]
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (7:BIGINT) <- [8]
2026-01-27 11:06:37 [http-nio-8080-exec-7] TRACE org.hibernate.orm.jdbc.bind - binding parameter (8:BIGINT) <- [9]
2026-01-27 11:06:37 [http-nio-8080-exec-7] INFO  j.s.s.s.CierreInventarioDiarioService - Cierre completado definitivamente ID: 9 para empresa ID: 3. Total ventas: 0.0, Cantidad facturas: 0
2026-01-27 11:06:37 [http-nio-8080-exec-7] INFO  j.s.s.c.CierreInventarioDiarioControlador - ‚úÖ Cierre completado definitivamente ID: 9
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 361, Tenant anterior: 3
2026-01-27 11:06:37 [http-nio-8080-exec-7] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 361, Request: /cierres/completar-definitivo/9, Empresa ID anterior: 3
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres, M√©todo: GET
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:06:37 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 362
2026-01-27 11:06:37 [http-nio-8080-exec-8] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:06:37 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:06:37 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:37 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:06:37 [http-nio-8080-exec-8] INFO  j.s.s.c.CierreInventarioDiarioControlador - üìã GET /cierres - Listando cierres diarios
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG j.s.s.s.CierreInventarioDiarioService - Obteniendo todos los cierres para empresa ID: 3
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        cid1_0.id,
        cid1_0.cantidad_facturas,
        cid1_0.empresa_id,
        cid1_0.estado,
        cid1_0.fecha,
        cid1_0.observaciones,
        cid1_0.total_ventas,
        cid1_0.usuario_id 
    from
        cierre_inventario_diario cid1_0 
    left join
        empresa e1_0 
            on e1_0.id=cid1_0.empresa_id 
    where
        e1_0.id=?
2026-01-27 11:06:37 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:37 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono,
        u1_0.nombre_usuario,
        u1_0.rol,
        s1_0.id,
        s1_0.direccion,
        s1_0.email,
        s1_0.empresa_id,
        e2_0.id,
        e2_0.email_contacto,
        e2_0.estado,
        e2_0.fecha_creacion,
        e2_0.nombre,
        e2_0.plan,
        e2_0.subdominio,
        e2_0.telefono,
        s1_0.nombre,
        s1_0.telefono 
    from
        usuario u1_0 
    left join
        empresa e1_0 
            on e1_0.id=u1_0.empresa_id 
    left join
        sucursal s1_0 
            on s1_0.id=u1_0.sucursal_id 
    left join
        empresa e2_0 
            on e2_0.id=s1_0.empresa_id 
    where
        u1_0.id=?
2026-01-27 11:06:37 [http-nio-8080-exec-8] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [8]
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG j.s.s.s.CierreInventarioDiarioService - Encontrados 4 cierres para empresa ID: 3
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG j.s.s.c.CierreInventarioDiarioControlador - Encontrados 4 cierres
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 362, Tenant anterior: 3
2026-01-27 11:06:37 [http-nio-8080-exec-8] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 362, Request: /cierres, Empresa ID anterior: 3
2026-01-27 11:06:40 [http-nio-8080-exec-9] DEBUG o.s.security.web.FilterChainProxy - Securing GET /principal
2026-01-27 11:06:40 [http-nio-8080-exec-9] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:06:40 [http-nio-8080-exec-9] DEBUG o.s.security.web.FilterChainProxy - Secured GET /principal
2026-01-27 11:06:40 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /principal, M√©todo: GET
2026-01-27 11:06:40 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:06:40 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:06:40 [http-nio-8080-exec-9] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:06:40 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:06:40 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 363
2026-01-27 11:06:40 [http-nio-8080-exec-9] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:06:40 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:06:40 [http-nio-8080-exec-9] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:06:40 [http-nio-8080-exec-9] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:06:40 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:06:40 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:40 [http-nio-8080-exec-9] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:40 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:40 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:06:40 [http-nio-8080-exec-9] DEBUG j.s.s.config.CierreDiarioInterceptor - üõ°Ô∏è Interceptor ejecutando - Ruta: /principal, Empresa ID: 3
2026-01-27 11:06:40 [http-nio-8080-exec-9] DEBUG j.s.s.config.CierreDiarioInterceptor - üìÖ Validaci√≥n de cierre - Fecha: 2026-01-27, Hora: 11:00
2026-01-27 11:06:40 [http-nio-8080-exec-9] DEBUG org.hibernate.SQL - 
    select
        case 
            when count(cid1_0.id)>0 
                then 1 
            else 0 
    end 
from
    cierre_inventario_diario cid1_0 
where
    cid1_0.fecha=? 
    and cid1_0.estado=? 
    and cid1_0.empresa_id=?
2026-01-27 11:06:40 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:DATE) <- [2026-01-27]
2026-01-27 11:06:40 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:VARCHAR) <- [COMPLETADO]
2026-01-27 11:06:40 [http-nio-8080-exec-9] TRACE org.hibernate.orm.jdbc.bind - binding parameter (3:BIGINT) <- [3]
2026-01-27 11:06:40 [http-nio-8080-exec-9] WARN  j.s.s.config.CierreDiarioInterceptor - üö´ ¬°HOY YA EST√Å CERRADO! - Bloqueando acceso. Empresa ID: 3, Fecha: 2026-01-27
2026-01-27 11:06:40 [http-nio-8080-exec-9] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 363, Tenant anterior: 3
2026-01-27 11:06:40 [http-nio-8080-exec-9] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 363, Request: /principal, Empresa ID anterior: 3
2026-01-27 11:06:40 [http-nio-8080-exec-10] DEBUG o.s.security.web.FilterChainProxy - Securing GET /cierres/bloqueado?proximoAcceso=2026-01-28%2005:00
2026-01-27 11:06:40 [http-nio-8080-exec-10] DEBUG o.s.s.w.c.HttpSessionSecurityContextRepository - Retrieved SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=admin, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=E225B8201C9D86085247C31DED0AF13B], Granted Authorities=[ROLE_ADMIN]]]
2026-01-27 11:06:40 [http-nio-8080-exec-10] DEBUG o.s.security.web.FilterChainProxy - Secured GET /cierres/bloqueado?proximoAcceso=2026-01-28%2005:00
2026-01-27 11:06:40 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantFilter - üìå TenantFilter - RUTA: /cierres/bloqueado, M√©todo: GET
2026-01-27 11:06:40 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantFilter - üåê Server Name: empanadas.localhost
2026-01-27 11:06:40 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantFilter - üîç Subdominio extra√≠do: empanadas
2026-01-27 11:06:40 [http-nio-8080-exec-10] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.subdominio=?
2026-01-27 11:06:40 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [empanadas]
2026-01-27 11:06:40 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantContext - üîß TenantContext.setCurrentTenant(3) - Hilo: 364
2026-01-27 11:06:40 [http-nio-8080-exec-10] INFO  j.s.s.context.TenantFilter - ‚úÖ Empresa establecida desde subdominio: 3 (Subdominio: empanadas)
2026-01-27 11:06:40 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantFilter - üë§ Usuario autenticado en TenantFilter: admin
2026-01-27 11:06:40 [http-nio-8080-exec-10] DEBUG j.s.s.servicios.UsuarioServicio - Buscando usuario: admin en empresa ID: 3
2026-01-27 11:06:40 [http-nio-8080-exec-10] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.activo,
        u1_0.contrasenna,
        u1_0.empresa_id,
        u1_0.nombre_usuario,
        u1_0.rol,
        u1_0.sucursal_id 
    from
        usuario u1_0 
    where
        u1_0.nombre_usuario=? 
        and u1_0.empresa_id=?
2026-01-27 11:06:40 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:VARCHAR) <- [admin]
2026-01-27 11:06:40 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (2:BIGINT) <- [3]
2026-01-27 11:06:40 [http-nio-8080-exec-10] DEBUG org.hibernate.SQL - 
    select
        e1_0.id,
        e1_0.email_contacto,
        e1_0.estado,
        e1_0.fecha_creacion,
        e1_0.nombre,
        e1_0.plan,
        e1_0.subdominio,
        e1_0.telefono 
    from
        empresa e1_0 
    where
        e1_0.id=?
2026-01-27 11:06:40 [http-nio-8080-exec-10] TRACE org.hibernate.orm.jdbc.bind - binding parameter (1:BIGINT) <- [3]
2026-01-27 11:06:40 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantFilter - ‚úÖ Usuario admin validado para empresa 3
2026-01-27 11:06:40 [http-nio-8080-exec-10] WARN  j.s.s.c.CierreInventarioDiarioControlador - ‚õî GET /cierres/bloqueado - Sistema bloqueado. Pr√≥ximo acceso: 2026-01-28 05:00
2026-01-27 11:06:40 [http-nio-8080-exec-10] DEBUG j.s.s.context.TenantContext - üßπ TenantContext.clear() - Hilo: 364, Tenant anterior: 3
2026-01-27 11:06:40 [http-nio-8080-exec-10] DEBUG j.s.s.c.TenantContextCleanupFilter - ‚úÖ TenantContext limpiado - Hilo: 364, Request: /cierres/bloqueado, Empresa ID anterior: 3
2026-01-27 11:43:07 [SpringApplicationShutdownHook] INFO  o.s.b.w.e.tomcat.GracefulShutdown - Commencing graceful shutdown. Waiting for active requests to complete
2026-01-27 11:43:07 [tomcat-shutdown] INFO  o.s.b.w.e.tomcat.GracefulShutdown - Graceful shutdown complete
2026-01-27 11:43:07 [SpringApplicationShutdownHook] INFO  o.s.o.j.LocalContainerEntityManagerFactoryBean - Closing JPA EntityManagerFactory for persistence unit 'default'
2026-01-27 11:43:07 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-14 - Shutdown initiated...
2026-01-27 11:43:07 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-14 - Shutdown completed.
