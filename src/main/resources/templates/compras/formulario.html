<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Nueva Compra - Proveedor</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
      :root {
        --negro: #0a0a0f;
        --morado: #667eea;
        --morado-oscuro: #764ba2;
        --verde: #06d6a0;
        --amarillo: #ffd166;
        --rojo: #ef476f;
        --gris-fondo: #f8fafc;
        --gris-borde: #e2e8f0;
        --blanco: #ffffff;
      }

      body {
        background-color: var(--gris-fondo);
        font-family: "Segoe UI", system-ui, sans-serif;
      }

      h4,
      h5 {
        font-weight: 700;
      }

      /* Cards */
      .card {
        border: 2px solid var(--gris-borde);
        border-radius: 14px;
        box-shadow: 0 6px 16px rgba(10, 10, 15, 0.08);
        position: relative;
        overflow: hidden;
      }

      .card::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background-color: var(--morado);
      }

      .card-header {
        background-color: var(--blanco);
        border-bottom: 2px solid var(--gris-borde);
        font-weight: 600;
      }

      .header-success {
        background-color: var(--verde);
        color: #000;
      }

      .header-info {
        background-color: var(--morado);
        color: #fff;
      }

      /* Formularios */
      .form-control,
      .form-select {
        border: 2px solid var(--gris-borde);
        border-radius: 10px;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: var(--morado);
        box-shadow: none;
      }

      /* Tabla */
      table {
        border: 2px solid var(--gris-borde);
      }

      thead {
        background-color: var(--gris-fondo);
      }

      tbody tr:nth-child(even) {
        background-color: #f1f5f9;
      }

      /* Badges */
      .badge {
        border-radius: 10px;
        font-weight: 600;
      }

      .bg-success {
        background-color: var(--verde) !important;
        color: #000;
      }

      /* Botones */
      .btn {
        border-radius: 10px;
        font-weight: 600;
      }

      .btn-success {
        background-color: var(--verde);
        border: 2px solid #04b88b;
        color: #000;
      }

      .btn-success:hover {
        background-color: #04b88b;
      }

      .btn-danger {
        background-color: var(--rojo);
        border: 2px solid #d63c60;
      }

      .btn-secondary {
        border: 2px solid var(--gris-borde);
      }

      /* Sticky panel */
      .sticky-top {
        top: 20px;
      }

      .alert-warning {
        background-color: var(--amarillo);
        border: 2px solid #e6bb5c;
        color: #000;
      }
    </style>
  </head>

  <body>
    <div class="container-fluid mt-3">
      <div class="row">
        <!-- COLUMNA IZQUIERDA: Formulario de compra -->
        <div class="col-md-8">
          <div class="card">
            <div class="card-header bg-success text-white">
              <h4 class="mb-0">üì¶ Nueva Compra a Proveedor</h4>
            </div>
            <div class="card-body">
              <form
                th:action="@{/compras/guardar}"
                method="post"
                id="formCompra"
              >
                <!-- Proveedor y fecha -->
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label class="form-label">Proveedor *</label>
                    <select
                      name="proveedor.id"
                      class="form-select"
                      required
                      id="selectProveedor"
                    >
                      <option value="">-- Seleccionar Proveedor --</option>
                      <option
                        th:each="proveedor : ${proveedores}"
                        th:value="${proveedor.id}"
                        th:text="${proveedor.nombre + ' (' + proveedor.identificacion + ')'}"
                      ></option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Fecha *</label>
                    <input
                      type="date"
                      name="fecha"
                      class="form-control"
                      th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}"
                      required
                    />
                  </div>
                </div>

                <!-- Agregar Ingrediente -->
                <div class="card mb-4">
                  <div class="card-header">
                    <h5 class="mb-0">Agregar Ingrediente</h5>
                  </div>
                  <div class="card-body">
                    <div class="row g-2">
                      <div class="col-md-5">
                        <select class="form-select" id="selectIngrediente">
                          <option value="">
                            -- Seleccionar Ingrediente --
                          </option>
                          <option
                            th:each="ingrediente : ${ingredientes}"
                            th:value="${ingrediente.id}"
                            th:text="${ingrediente.nombre + ' - Stock: ' + ingrediente.stockActual + ' ' + ingrediente.unidadMedida}"
                            th:data-precio="${ingrediente.precio}"
                            th:data-stock="${ingrediente.stockActual}"
                            th:data-unidad="${ingrediente.unidadMedida}"
                          ></option>
                        </select>
                      </div>
                      <div class="col-md-3">
                        <input
                          type="number"
                          id="inputCantidad"
                          class="form-control"
                          placeholder="Cantidad"
                          min="0.01"
                          step="0.01"
                          value="1"
                        />
                      </div>
                      <div class="col-md-2">
                        <input
                          type="number"
                          id="inputPrecio"
                          class="form-control"
                          placeholder="Precio Unit."
                          min="0"
                          step="0.01"
                        />
                      </div>
                      <div class="col-md-2">
                        <button
                          type="button"
                          id="btnAgregar"
                          class="btn btn-success w-100"
                        >
                          Agregar
                        </button>
                      </div>
                    </div>
                    <small class="text-muted mt-2"
                      >Los precios est√°n en COP por unidad de medida</small
                    >
                  </div>
                </div>

                <!-- Lista de Ingredientes en la Compra -->
                <div class="card mb-4">
                  <div
                    class="card-header d-flex justify-content-between align-items-center"
                  >
                    <h5 class="mb-0">Ingredientes a Comprar</h5>
                    <span class="badge bg-success" id="contadorIngredientes"
                      >0 ingredientes</span
                    >
                  </div>
                  <div class="card-body">
                    <table class="table table-hover" id="tablaIngredientes">
                      <thead>
                        <tr>
                          <th>Ingrediente</th>
                          <th width="120">Cantidad</th>
                          <th width="150">Precio Unit.</th>
                          <th width="150">Subtotal</th>
                          <th width="50"></th>
                        </tr>
                      </thead>
                      <tbody id="tbodyIngredientes">
                        <!-- Se llenar√° din√°micamente -->
                      </tbody>
                      <tfoot>
                        <tr>
                          <td colspan="3" class="text-end">
                            <strong>Subtotal:</strong>
                          </td>
                          <td id="subtotalTotal">$0.00</td>
                          <td></td>
                        </tr>
                        <tr>
                          <td colspan="3" class="text-end">
                            <strong>IVA (19%):</strong>
                          </td>
                          <td id="ivaTotal">$0.00</td>
                          <td></td>
                        </tr>
                        <tr class="table-active">
                          <td colspan="3" class="text-end">
                            <strong>TOTAL COMPRA:</strong>
                          </td>
                          <td id="totalFinal" class="fw-bold">$0.00</td>
                          <td></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>

                <!-- Campos ocultos para enviar datos -->
                <div id="hiddenInputs">
                  <!-- Se llenar√°n din√°micamente -->
                </div>

                <div class="d-flex justify-content-between">
                  <button
                    type="button"
                    id="btnCancelar"
                    class="btn btn-secondary"
                    onclick="
                      if (confirm('¬øSeguro que deseas cancelar esta Compra?'))
                        window.location.href = '/principal';
                    "
                  >
                    Cancelar Compra
                  </button>
                  <button
                    type="submit"
                    id="btnRegistrar"
                    class="btn btn-success btn-lg"
                    disabled
                  >
                    ‚úÖ Registrar Compra
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- COLUMNA DERECHA: Resumen y ayuda -->
        <div class="col-md-4">
          <div class="card sticky-top" style="top: 20px">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">üìä Informaci√≥n de Compra e Instrucciones</h5>
            </div>
            <div class="card-body">
              <div class="alert alert-warning small mt-3">
                <strong>‚ö†Ô∏è Importante:</strong>
                <ul class="mb-0">
                  <li>
                    Al registrar la compra, el stock se actualizar√°
                    autom√°ticamente
                  </li>
                  <li>
                    Los precios de compra se actualizar√°n con los nuevos valores
                  </li>
                  <li>El n√∫mero de factura se generar√° autom√°ticamente</li>
                  <ol class="small">
                    <li>------------Instrucciones-------------</li>
                    <li>Selecciona un proveedor</li>
                    <li>Ingresa ingrediente</li>
                    <li>Ingresa cantidad</li>
                    <li>Haz clic en "Agregar"</li>
                    <li>Revisa el total</li>
                    <li>¬°Reguistra Compra!</li>
                  </ol>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Plantilla para fila de ingrediente (hidden) -->
    <template id="plantillaIngrediente">
      <tr>
        <td>
          <span class="nombreIngrediente"></span>
          <input
            type="hidden"
            name="detalles[].ingrediente.id"
            class="inputIngredienteId"
          />
          <input
            type="hidden"
            name="detalles[].ingrediente.nombre"
            class="inputIngredienteNombre"
          />
        </td>
        <td>
          <div class="input-group input-group-sm">
            <input
              type="number"
              name="detalles[].cantidad"
              class="form-control inputCantidad"
              min="0.01"
              step="0.01"
              value="1"
            />
            <span class="input-group-text unidadMedida"></span>
          </div>
        </td>
        <td>
          <input
            type="number"
            name="detalles[].precioUnitario"
            class="form-control form-control-sm inputPrecio"
            min="0"
            step="0.01"
            value="0"
          />
        </td>
        <td class="subtotalFila">$0.00</td>
        <td>
          <button type="button" class="btn btn-sm btn-danger btnQuitar">
            ‚úï
          </button>
        </td>
      </tr>
    </template>

    <script>
      $(document).ready(function () {
        let ingredientesAgregados = [];
        let indiceDetalle = 0;

        // Cargar precio sugerido al seleccionar ingrediente
        $("#selectIngrediente").change(function () {
          const precio =
            parseFloat($(this).find("option:selected").data("precio")) || 0;
          $("#inputPrecio").val(precio.toFixed(2));
        });

        // Agregar ingrediente a la tabla
        $("#btnAgregar").click(function () {
          const select = $("#selectIngrediente");
          const ingredienteId = select.val();
          const ingredienteTexto = select.find("option:selected").text();
          const precioUnitario = parseFloat($("#inputPrecio").val()) || 0;
          const cantidad = parseFloat($("#inputCantidad").val()) || 1;
          const unidadMedida =
            select.find("option:selected").data("unidad") || "u";

          if (!ingredienteId) {
            alert("Selecciona un ingrediente");
            return;
          }

          if (cantidad <= 0) {
            alert("La cantidad debe ser mayor a 0");
            return;
          }

          if (precioUnitario <= 0) {
            alert("El precio debe ser mayor a 0");
            return;
          }

          // Agregar nuevo ingrediente con √≠ndice √∫nico
          ingredientesAgregados.push({
            id: ingredienteId,
            nombre: ingredienteTexto.split(" - ")[0], // Solo el nombre
            precio: precioUnitario,
            cantidad: cantidad,
            unidad: unidadMedida,
            indice: indiceDetalle++,
          });

          actualizarTabla();

          // Resetear inputs
          select.val("");
          $("#inputCantidad").val(1);
          $("#inputPrecio").val("");
        });

        // Actualizar tabla y totales
        function actualizarTabla() {
          const tbody = $("#tbodyIngredientes");
          const hiddenInputs = $("#hiddenInputs");
          tbody.empty();
          hiddenInputs.empty();

          let subtotal = 0;

          ingredientesAgregados.forEach((ingrediente, index) => {
            // Clonar plantilla
            const template = $("#plantillaIngrediente").html();
            const $fila = $(template);

            // Reemplazar √≠ndice en los nombres
            $fila.html(
              $fila.html().replace(/\[\]/g, "[" + ingrediente.indice + "]"),
            );

            // Llenar datos
            $fila.find(".nombreIngrediente").text(ingrediente.nombre);
            $fila.find(".inputIngredienteId").val(ingrediente.id);
            $fila.find(".inputIngredienteNombre").val(ingrediente.nombre);
            $fila.find(".inputCantidad").val(ingrediente.cantidad);
            $fila.find(".unidadMedida").text(ingrediente.unidad);
            $fila.find(".inputPrecio").val(ingrediente.precio);

            const subtotalFila = ingrediente.precio * ingrediente.cantidad;
            $fila.find(".subtotalFila").text("$" + subtotalFila.toFixed(2));
            subtotal += subtotalFila;

            // Eventos para actualizar en tiempo real
            $fila.find(".inputCantidad, .inputPrecio").on("input", function () {
              const nuevaCantidad =
                parseFloat($fila.find(".inputCantidad").val()) || 0;
              const nuevoPrecio =
                parseFloat($fila.find(".inputPrecio").val()) || 0;

              ingredientesAgregados[index].cantidad = nuevaCantidad;
              ingredientesAgregados[index].precio = nuevoPrecio;

              const nuevoSubtotal = nuevaCantidad * nuevoPrecio;
              $fila.find(".subtotalFila").text("$" + nuevoSubtotal.toFixed(2));

              calcularTotales();
            });

            // Evento para quitar
            $fila.find(".btnQuitar").click(function () {
              ingredientesAgregados.splice(index, 1);
              actualizarTabla();
            });

            tbody.append($fila);
          });

          calcularTotales();
        }

        // Calcular totales
        function calcularTotales() {
          let subtotal = 0;

          ingredientesAgregados.forEach((ingrediente) => {
            subtotal += ingrediente.precio * ingrediente.cantidad;
          });

          const iva = subtotal * 0.19;
          const total = subtotal + iva;

          $("#subtotalTotal").text("$" + subtotal.toFixed(2));
          $("#ivaTotal").text("$" + iva.toFixed(2));
          $("#totalFinal").text("$" + total.toFixed(2));

          // Actualizar contador
          $("#contadorIngredientes").text(
            ingredientesAgregados.length + " ingredientes",
          );

          // Habilitar/deshabilitar bot√≥n
          $("#btnRegistrar").prop(
            "disabled",
            ingredientesAgregados.length === 0,
          );
        }

        // Cancelar compra
        $("#btnCancelar").click(function () {
          if (
            ingredientesAgregados.length > 0 &&
            !confirm(
              "¬øCancelar esta compra? Se perder√°n los ingredientes agregados.",
            )
          ) {
            return;
          }
          ingredientesAgregados = [];
          indiceDetalle = 0;
          actualizarTabla();
          $("#selectIngrediente").val("");
          $("#inputCantidad").val(1);
          $("#inputPrecio").val("");
        });

        // Validar antes de enviar
        $("#formCompra").submit(function (e) {
          if (ingredientesAgregados.length === 0) {
            e.preventDefault();
            alert("Agrega al menos un ingrediente a la compra");
            return false;
          }

          if (!$("#selectProveedor").val()) {
            e.preventDefault();
            alert("Selecciona un proveedor");
            return false;
          }

          // Validar que todos los precios sean v√°lidos
          let precioValido = true;
          ingredientesAgregados.forEach((ingrediente) => {
            if (ingrediente.precio <= 0) {
              precioValido = false;
            }
          });

          if (!precioValido) {
            e.preventDefault();
            alert("Todos los precios deben ser mayores a 0");
            return false;
          }

          return confirm(
            "¬øConfirmar registro de compra? El stock se actualizar√° autom√°ticamente.",
          );
        });
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
