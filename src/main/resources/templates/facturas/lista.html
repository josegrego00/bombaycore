<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Facturas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>üßæ Facturas</h1>
            <div>
                <a th:href="@{/principal}" class="btn btn-secondary">‚Üê Volver</a>
            </div>
        </div>

        <!-- FILTROS DE FECHA -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <input type="hidden" name="pagina" value="0">
                    <input type="hidden" name="tamanio" th:value="${tamanio}">
                    
                    <div class="col-md-4">
                        <label for="fechaInicio" class="form-label">Fecha desde</label>
                        <input type="date" class="form-control" id="fechaInicio" name="fechaInicio"
                               th:value="${fechaInicio != null ? #temporals.format(fechaInicio, 'yyyy-MM-dd') : ''}">
                    </div>
                    
                    <div class="col-md-4">
                        <label for="fechaFin" class="form-label">Fecha hasta</label>
                        <input type="date" class="form-control" id="fechaFin" name="fechaFin"
                               th:value="${fechaFin != null ? #temporals.format(fechaFin, 'yyyy-MM-dd') : ''}">
                    </div>
                    
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="bi bi-search me-1"></i>Buscar
                        </button>
                        <a th:href="@{/facturas}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle me-1"></i>Limpiar
                        </a>
                    </div>
                </form>
                
                <!-- Filtros activos -->
                <div th:if="${fechaInicio != null or fechaFin != null}" class="mt-3">
                    <small class="text-muted">
                        <i class="bi bi-funnel me-1"></i>
                        Filtrado: 
                        <span th:if="${fechaInicio != null}">
                            desde <strong th:text="${#temporals.format(fechaInicio, 'dd/MM/yyyy')}"></strong>
                        </span>
                        <span th:if="${fechaFin != null}">
                            <span th:if="${fechaInicio != null}"> hasta </span>
                            <strong th:text="${#temporals.format(fechaFin, 'dd/MM/yyyy')}"></strong>
                        </span>
                        <a th:href="@{/facturas}" class="ms-2 text-decoration-none">
                            <i class="bi bi-x-circle"></i> quitar
                        </a>
                    </small>
                </div>
            </div>
        </div>

        <!-- INFORMACI√ìN Y CONTROLES -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <span th:if="${totalElementos > 0}" class="text-muted">
                    Mostrando <strong th:text="${facturas.size()}">0</strong> de 
                    <strong th:text="${totalElementos}">0</strong> facturas
                </span>
                <span th:if="${totalElementos == 0}" class="text-muted">
                    No hay facturas registradas
                </span>
            </div>
            <div>
                <span class="me-2">Mostrar:</span>
                <select class="form-select form-select-sm d-inline-block w-auto" 
                        onchange="location.href=buildUrl(0, this.value)">
                    <option value="5" th:selected="${tamanio == 5}">5</option>
                    <option value="10" th:selected="${tamanio == 10}">10</option>
                    <option value="20" th:selected="${tamanio == 20}">20</option>
                    <option value="50" th:selected="${tamanio == 50}">50</option>
                </select>
            </div>
        </div>

        <!-- TABLA -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>No. Factura</th>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Estado</th>
                                <th>Total</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="factura : ${facturas}">
                                <td th:text="${factura.numeroFactura}"></td>
                                <td th:text="${#temporals.format(factura.fecha, 'dd/MM/yyyy HH:mm')}"></td>
                                <td>
                                    <span th:if="${factura.cliente != null}"
                                          th:text="${factura.cliente.nombre}"
                                          class="badge bg-info text-dark"></span>
                                    <span th:unless="${factura.cliente != null}"
                                          class="text-muted">Consumidor Final</span>
                                </td>
                                <td>
                                    <span th:if="${factura.estado == 'PENDIENTE'}"
                                          class="badge bg-warning">Pendiente</span>
                                    <span th:if="${factura.estado == 'PAGADA'}"
                                          class="badge bg-success">Pagada</span>
                                    <span th:if="${factura.estado == 'ANULADA'}"
                                          class="badge bg-danger">Anulada</span>
                                </td>
                                <td th:text="${'$' + #numbers.formatDecimal(factura.total, 1, 2)}"></td>
                                <td>
                                    <a th:href="@{/facturas/detalle/{id}(id=${factura.id})}"
                                       class="btn btn-sm btn-info">Ver</a>
                                    <a th:if="${factura.estado == 'PAGADA'}"
                                       th:href="@{/facturas/anular/{id}(id=${factura.id})}"
                                       class="btn btn-sm btn-warning"
                                       onclick="return confirm('¬øAnular esta factura?')">Anular</a>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(facturas)}">
                                <td colspan="6" class="text-center text-muted py-4">
                                    No hay facturas para mostrar
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- PAGINACI√ìN -->
                <div th:if="${totalPaginas > 1}" class="mt-4">
                    <nav>
                        <ul class="pagination justify-content-center mb-0">
                            <!-- Primera p√°gina -->
                            <li class="page-item" th:classappend="${paginaActual == 0} ? 'disabled'">
                                <a class="page-link" th:href="@{${buildPageUrl(0)}}">
                                    <i class="bi bi-chevron-double-left"></i>
                                </a>
                            </li>
                            
                            <!-- P√°gina anterior -->
                            <li class="page-item" th:classappend="${paginaActual == 0} ? 'disabled'">
                                <a class="page-link" th:href="@{${buildPageUrl(paginaActual-1)}}">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            
                            <!-- P√°ginas -->
                            <li th:each="i : ${#numbers.sequence(
                                  Math.max(0, paginaActual - 2), 
                                  Math.min(totalPaginas - 1, paginaActual + 2)
                                )}"
                                class="page-item" th:classappend="${i == paginaActual} ? 'active'">
                                <a class="page-link" 
                                   th:href="@{${buildPageUrl(i)}}"
                                   th:text="${i + 1}">1</a>
                            </li>
                            
                            <!-- P√°gina siguiente -->
                            <li class="page-item" th:classappend="${paginaActual == totalPaginas-1} ? 'disabled'">
                                <a class="page-link" th:href="@{${buildPageUrl(paginaActual+1)}}">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            
                            <!-- √öltima p√°gina -->
                            <li class="page-item" th:classappend="${paginaActual == totalPaginas-1} ? 'disabled'">
                                <a class="page-link" th:href="@{${buildPageUrl(totalPaginas-1)}}">
                                    <i class="bi bi-chevron-double-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                    
                    <div class="text-center text-muted mt-2">
                        P√°gina <span th:text="${paginaActual + 1}">1</span> de 
                        <span th:text="${totalPaginas}">1</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Funci√≥n para formatear la fecha como YYYY-MM-DD
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Establecer la fecha actual al cargar la p√°gina SOLO si no hay valores establecidos
        document.addEventListener('DOMContentLoaded', function() {
            const fechaInicioInput = document.getElementById('fechaInicio');
            const fechaFinInput = document.getElementById('fechaFin');
            const today = getTodayDate();
            
            // Solo establecer fecha de hoy si los campos est√°n vac√≠os
            if (!fechaInicioInput.value) {
                fechaInicioInput.value = today;
            }
            if (!fechaFinInput.value) {
                fechaFinInput.value = today;
            }
        });
        
        // Funci√≥n para construir URLs con par√°metros
        function buildUrl(pagina, tamanio) {
            let url = '/facturas?pagina=' + pagina + '&tamanio=' + tamanio;
            
            // Obtener valores de los filtros
            const fechaInicio = document.getElementById('fechaInicio')?.value;
            const fechaFin = document.getElementById('fechaFin')?.value;
            
            if (fechaInicio) url += '&fechaInicio=' + fechaInicio;
            if (fechaFin) url += '&fechaFin=' + fechaFin;
            
            return url;
        }
        
        // Para el select de tama√±o
        document.querySelector('select[onchange*="buildUrl"]').onchange = function() {
            location.href = buildUrl(0, this.value);
        };
    </script>
    
    <!-- Helper en Thymeleaf para construir URLs -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        function buildPageUrl(pagina) {
            let url = '/facturas?pagina=' + pagina + '&tamanio=' + '[[${tamanio}]]';
            
            /*[[${fechaInicio}]]*/ const fechaInicio = '[[${fechaInicio}]]';
            /*[[${fechaFin}]]*/ const fechaFin = '[[${fechaFin}]]';
            
            if (fechaInicio) url += '&fechaInicio=' + fechaInicio;
            if (fechaFin) url += '&fechaFin=' + fechaFin;
            
            return url;
        }
        /*]]>*/
    </script>
</body>
</html>