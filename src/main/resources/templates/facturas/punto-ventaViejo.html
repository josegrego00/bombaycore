<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Punto de Venta</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- En el <head> -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="container-fluid mt-3">
      <div class="row">
        <!-- COLUMNA IZQUIERDA: Formulario de venta -->
        <div class="col-md-8">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h4 class="mb-0">üõí Punto de Venta</h4>
            </div>
            <div class="card-body">
              <form
                th:action="@{/facturas/guardar}"
                method="post"
                id="formFactura"
              >
                <!-- Cliente -->
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label class="form-label">Cliente (Opcional)</label>
                    <select name="clienteId" class="form-select">
                      <option value="">Consumidor Final</option>
                      <option
                        th:each="cliente : ${clientes}"
                        th:value="${cliente.id}"
                        th:text="${cliente.nombre}"
                      ></option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Forma de Pago *</label>
                    <select name="formaPago" class="form-select" required>
                      <option value="EFECTIVO">Efectivo</option>
                      <option value="TARJETA">Tarjeta</option>
                      <option value="TRANSFERENCIA">Transferencia</option>
                    </select>
                  </div>
                </div>

                <!-- Agregar Producto -->
                <div class="card mb-4">
                  <div class="card-header">
                    <h5 class="mb-0">Agregar Producto</h5>
                  </div>
                  <div class="card-body">
                    <div class="row g-2">
                      <div class="col-md-6">
                        <select class="form-select" id="selectProducto">
                          <option value="">-- Seleccionar Producto --</option>
                          <option
                            th:each="producto : ${productos}"
                            th:value="${producto.id}"
                            th:text="${producto.nombre + ' - $' + #numbers.formatDecimal(producto.precioVenta, 1, 2) + ' (Stock: ' + producto.stock + ')'}"
                            th:data-precio="${producto.precioVenta}"
                            th:data-stock="${producto.stock}"
                          ></option>
                        </select>
                      </div>
                      <div class="col-md-3">
                        <input
                          type="number"
                          id="inputCantidad"
                          class="form-control"
                          placeholder="Cantidad"
                          min="1"
                          value="1"
                        />
                      </div>
                      <div class="col-md-3">
                        <button
                          type="button"
                          id="btnAgregar"
                          class="btn btn-success w-100"
                        >
                          Agregar
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Lista de Productos en la Factura -->
                <div class="card mb-4">
                  <div
                    class="card-header d-flex justify-content-between align-items-center"
                  >
                    <h5 class="mb-0">Productos a Facturar</h5>
                    <span class="badge bg-primary" id="contadorProductos"
                      >0 productos</span
                    >
                  </div>
                  <div class="card-body">
                    <table class="table table-hover" id="tablaProductos">
                      <thead>
                        <tr>
                          <th>Producto</th>
                          <th width="100">Cantidad</th>
                          <th width="120">Precio Unit.</th>
                          <th width="120">Subtotal</th>
                          <th width="50"></th>
                        </tr>
                      </thead>
                      <tbody id="tbodyProductos">
                        <!-- Se llenar√° din√°micamente -->
                      </tbody>
                      <tfoot>
                        <tr>
                          <td colspan="3" class="text-end">
                            <strong>Subtotal:</strong>
                          </td>
                          <td id="subtotalTotal">$0.00</td>
                          <td></td>
                        </tr>
                        <tr>
                          <td colspan="3" class="text-end">
                            <strong>IVA (19%):</strong>
                          </td>
                          <td id="ivaTotal">$0.00</td>
                          <td></td>
                        </tr>
                        <tr class="table-active">
                          <td colspan="3" class="text-end">
                            <strong>TOTAL:</strong>
                          </td>
                          <td id="totalFinal" class="fw-bold">$0.00</td>
                          <td></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>

                <!-- Campos ocultos para enviar datos -->
                <div id="hiddenInputs">
                  <!-- Se llenar√°n din√°micamente -->
                </div>

                <div class="d-flex justify-content-between">
                  <button
                    type="button"
                    id="btnCancelar"
                    class="btn btn-secondary"
                    onclick="if(confirm('¬øSeguro que deseas cancelar esta venta?')) window.location.href='/principal'"
                  >
                    Cancelar Venta
                  </button>
                  <button
                    type="submit"
                    id="btnFacturar"
                    class="btn btn-success btn-lg"
                    disabled
                  >
                    üí∞ Facturar
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- COLUMNA DERECHA: Resumen r√°pido -->
        <div class="col-md-4">
          <div class="card sticky-top" style="top: 20px">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">üìä Instrucciones</h5>
            </div>
            <ol class="small">
              <li>-------------------------</li>
              <li>Selecciona un producto</li>
              <li>Ingresa cantidad</li>
              <li>Haz clic en "Agregar"</li>
              <li>Revisa el total</li>
              <li>¬°Factura!</li>
            </ol>

            <div class="alert alert-warning small mt-3">
              <strong>‚ö†Ô∏è Nota:</strong> El stock se descuenta autom√°ticamente al
              facturar.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Plantilla para fila de producto (hidden) -->
    <template id="plantillaProducto">
      <tr>
        <td>
          <span class="nombreProducto"></span>
          <input type="hidden" name="productoIds" class="inputProductoId" />
        </td>
        <td>
          <input
            type="number"
            name="cantidades"
            class="form-control form-control-sm inputCantidad"
            min="1"
            value="1"
            style="width: 80px"
          />
        </td>
        <td class="precioUnitario">$0.00</td>
        <td class="subtotalFila">$0.00</td>
        <td>
          <button type="button" class="btn btn-sm btn-danger btnQuitar">
            ‚úï
          </button>
        </td>
      </tr>
    </template>

    <script>
      $(document).ready(function () {
        let productosAgregados = [];

        // Agregar producto a la tabla
        $("#btnAgregar").click(function () {
          const select = $("#selectProducto");
          const productoId = select.val();
          const productoNombre = select.find("option:selected").text();
          const precio =
            parseFloat(select.find("option:selected").data("precio")) || 0;
          const stock =
            parseInt(select.find("option:selected").data("stock")) || 0;
          let cantidad = parseInt($("#inputCantidad").val()) || 1;

          if (!productoId) {
            alert("Selecciona un producto");
            return;
          }

          if (cantidad < 1) {
            alert("Cantidad m√≠nima: 1");
            return;
          }

          if (cantidad > stock) {
            alert("Stock insuficiente. Disponible: " + stock);
            return;
          }

          // Verificar si ya existe
          const indexExistente = productosAgregados.findIndex(
            (p) => p.id == productoId
          );
          if (indexExistente !== -1) {
            // Actualizar cantidad
            productosAgregados[indexExistente].cantidad += cantidad;
            actualizarTabla();
          } else {
            // Agregar nuevo
            productosAgregados.push({
              id: productoId,
              nombre: productoNombre.split(" - ")[0], // Solo el nombre
              precio: precio,
              cantidad: cantidad,
            });
            actualizarTabla();
          }

          // Resetear inputs
          select.val("");
          $("#inputCantidad").val(1);
        });

        // Actualizar tabla y totales
        function actualizarTabla() {
          const tbody = $("#tbodyProductos");
          const hiddenInputs = $("#hiddenInputs");
          tbody.empty();
          hiddenInputs.empty();

          let subtotal = 0;

          productosAgregados.forEach((producto, index) => {
            // Clonar plantilla
            const template = $("#plantillaProducto").html();
            const $fila = $(template);

            // Llenar datos
            $fila.find(".nombreProducto").text(producto.nombre);
            $fila.find(".inputProductoId").val(producto.id);
            $fila.find(".inputCantidad").val(producto.cantidad);
            $fila
              .find(".precioUnitario")
              .text("$" + producto.precio.toFixed(2));

            const subtotalFila = producto.precio * producto.cantidad;
            $fila.find(".subtotalFila").text("$" + subtotalFila.toFixed(2));
            subtotal += subtotalFila;

            // Evento para cambiar cantidad
            $fila.find(".inputCantidad").change(function () {
              const nuevaCantidad = parseInt($(this).val()) || 1;
              productosAgregados[index].cantidad = nuevaCantidad;
              actualizarTabla();
            });

            // Evento para quitar
            $fila.find(".btnQuitar").click(function () {
              productosAgregados.splice(index, 1);
              actualizarTabla();
            });

            tbody.append($fila);
          });

          // Calcular totales
          const totalConIva = subtotal; // El subtotal ya incluye IVA
          const base = totalConIva / 1.19;
          const iva = base * 0.19;

          $("#subtotalTotal").text("$" + base.toFixed(2)); // Base sin IVA
          $("#ivaTotal").text("$" + iva.toFixed(2)); // IVA calculado
          $("#totalFinal").text("$" + totalConIva.toFixed(2)); // Total con IVA incluido

          // Actualizar contador
          $("#contadorProductos").text(
            productosAgregados.length + " productos"
          );

          // Habilitar/deshabilitar bot√≥n facturar
          $("#btnFacturar").prop("disabled", productosAgregados.length === 0);
        }

        // Cancelar venta
        $("#btnCancelar").click(function () {
          if (
            productosAgregados.length > 0 &&
            !confirm(
              "¬øCancelar esta venta? Se perder√°n los productos agregados."
            )
          ) {
            return;
          }
          productosAgregados = [];
          actualizarTabla();
          $("#selectProducto").val("");
          $("#inputCantidad").val(1);
        });

        // Validar antes de enviar
        $("#formFactura").submit(function (e) {
          if (productosAgregados.length === 0) {
            e.preventDefault();
            alert("Agrega al menos un producto");
            return false;
          }

          // Validar stock nuevamente
          let stockValido = true;
          let mensajeError = "";

          productosAgregados.forEach((producto) => {
            const option = $(
              '#selectProducto option[value="' + producto.id + '"]'
            );
            const stock = parseInt(option.data("stock")) || 0;

            if (producto.cantidad > stock) {
              stockValido = false;
              mensajeError += `\n${producto.nombre}: Stock disponible ${stock}, solicitado ${producto.cantidad}`;
            }
          });

          if (!stockValido) {
            e.preventDefault();
            alert("Error de stock:" + mensajeError);
            return false;
          }

          return confirm(
            "¬øConfirmar facturaci√≥n? Esta acci√≥n no se puede deshacer."
          );
        });
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
