<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title th:text="${titulo}">Gestión de Recetas - MiBombay</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
      :root {
        --negro: #0a0a0f;
        --morado: #667eea;
        --morado-oscuro: #764ba2;
        --gris-fondo: #f8fafc;
        --gris-borde: #e2e8f0;
        --blanco: #ffffff;
        --verde: #06d6a0;
        --rojo: #ef476f;
      }

      body {
        background-color: var(--gris-fondo);
        font-family: "Segoe UI", system-ui, sans-serif;
        padding: 30px 15px;
      }

      .container-main {
        max-width: 1100px;
        margin: auto;
      }

      /* HEADER */
      .header-section {
        background-color: var(--negro);
        border: 3px solid var(--morado);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(10, 10, 15, 0.25);
      }

      .page-title {
        color: var(--blanco);
        font-size: 2rem;
        font-weight: 700;
      }

      .page-subtitle {
        color: #a0aec0;
        font-size: 0.95rem;
      }

      /* CARD */
      .card-custom {
        background: var(--blanco);
        border-radius: 14px;
        border: 2px solid var(--gris-borde);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        position: relative;
      }

      .card-custom::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background-color: var(--morado);
      }

      .card-header-custom {
        background: #f8fafc;
        padding: 1.2rem 1.5rem;
        font-weight: 600;
        border-bottom: 2px solid var(--gris-borde);
      }

      /* INGREDIENTES */
      .ingrediente-fila {
        background: #f9fafb;
        border-radius: 10px;
        padding: 10px;
      }

      /* BOTONES */
      .btn-primary-custom {
        background-color: var(--morado);
        border: 2px solid var(--morado-oscuro);
        color: white;
        font-weight: 600;
        border-radius: 10px;
      }

      .btn-primary-custom:hover {
        background-color: var(--morado-oscuro);
      }

      .btn-danger-custom {
        background-color: var(--rojo);
        border: none;
        color: white;
      }

      .btn-danger-custom:hover {
        opacity: 0.9;
      }

      .btn-success-custom {
        background-color: var(--verde);
        border: none;
        color: #0a0a0f;
        font-weight: 600;
      }

      .costo-box {
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--verde);
      }
      /* ESPACIADO INTERNO DEL CARD */
      .card-body {
        padding: 1.75rem 2rem; /* separación real del borde */
      }
    </style>
  </head>

  <body>
    <div class="container container-main">
      <!-- HEADER -->
      <div class="header-section">
        <h1 class="page-title">
          <i class="bi bi-journal-text me-2"></i>
          <span th:text="${titulo}"></span>
        </h1>
        <p class="page-subtitle">Administra las recetas y sus ingredientes</p>
      </div>

      <!-- FORM CARD -->
      <div class="card-custom">
        <div class="card-header-custom">
          <i class="bi bi-info-circle me-2"></i> Información de la receta
        </div>

        <div class="card-body">
          <!-- MENSAJE DE ERROR -->
          <div th:if="${error}" class="alert alert-danger mt-2">
            <strong>Error:</strong> <span th:text="${error}"></span>
          </div>

          <form th:action="@{/recetas/guardar}" method="post">
            <input type="hidden" name="id" th:value="${receta.id}" />

            <!-- DATOS GENERALES -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label fw-bold">Nombre *</label>
                <input
                  type="text"
                  name="nombre"
                  th:value="${receta.nombre}"
                  class="form-control"
                  required
                />
              </div>

              <div class="col-md-6">
                <label class="form-label fw-bold">Costo Calculado</label>
                <input
                  type="text"
                  class="form-control bg-light costo-box"
                  th:value="${'$' + #numbers.formatDecimal(receta.costoReceta, 1, 2)}"
                  readonly
                />
              </div>
            </div>

            <div class="mb-4">
              <label class="form-label fw-bold">Descripción</label>
              <textarea
                name="descripcion"
                class="form-control"
                rows="2"
                th:text="${receta.descripcion}"
              ></textarea>
            </div>

            <!-- INGREDIENTES -->
            <div class="card mb-4">
              <div
                class="card-header d-flex justify-content-between align-items-center"
              >
                <h5 class="mb-0 fw-bold">
                  <i class="bi bi-box-seam me-2"></i> Ingredientes
                </h5>
                <button
                  type="button"
                  class="btn btn-success-custom btn-sm"
                  id="agregarIngrediente"
                >
                  <i class="bi bi-plus-circle me-1"></i> Agregar
                </button>
              </div>

              <div class="card-body">
                <div id="ingredientesContainer">
                  <div
                    class="row mb-2 ingrediente-fila"
                    th:each="detalle : ${receta.ingredientes}"
                  >
                    <div class="col-md-6">
                      <select name="ingredienteIds" class="form-select">
                        <option value="">Seleccionar ingrediente</option>
                        <option
                          th:each="ing : ${ingredientes}"
                          th:value="${ing.id}"
                          th:text="${ing.nombre + ' (' + ing.unidadMedida + ')'}"
                          th:selected="${detalle.ingrediente.id == ing.id}"
                        ></option>
                      </select>
                    </div>

                    <div class="col-md-4">
                      <input
                        type="number"
                        step="0.01"
                        name="cantidades"
                        class="form-control"
                        placeholder="Cantidad"
                        th:value="${detalle.cantidadIngrediente}"
                      />
                    </div>

                    <div class="col-md-2 d-flex align-items-center">
                      <button
                        type="button"
                        class="btn btn-danger-custom btn-sm quitarIngrediente"
                      >
                        ✕
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- BOTONES -->
            <div class="d-flex justify-content-between">
              <a th:href="@{/recetas}" class="btn btn-secondary">
                <i class="bi bi-arrow-left me-1"></i> Cancelar
              </a>

              <button type="submit" class="btn btn-primary-custom">
                <i class="bi bi-save me-1"></i> Guardar Receta
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- PLANTILLA INGREDIENTE -->
    <div id="plantillaIngrediente" style="display: none">
      <div class="row mb-2 ingrediente-fila">
        <div class="col-md-6">
          <select name="ingredienteIds" class="form-select">
            <option value="">Seleccionar ingrediente</option>
            <option
              th:each="ing : ${ingredientes}"
              th:value="${ing.id}"
              th:text="${ing.nombre + ' (' + ing.unidadMedida + ')'}"
            ></option>
          </select>
        </div>

        <div class="col-md-4">
          <input
            type="number"
            step="0.01"
            name="cantidades"
            class="form-control"
            placeholder="Cantidad"
          />
        </div>

        <div class="col-md-2 d-flex align-items-center">
          <button
            type="button"
            class="btn btn-danger-custom btn-sm quitarIngrediente"
          >
            ✕
          </button>
        </div>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        $("#agregarIngrediente").click(function () {
          $("#ingredientesContainer").append($("#plantillaIngrediente").html());
        });

        $(document).on("click", ".quitarIngrediente", function () {
          if ($(".ingrediente-fila").length > 1) {
            $(this).closest(".ingrediente-fila").remove();
          } else {
            alert("Debe haber al menos un ingrediente");
          }
        });
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
