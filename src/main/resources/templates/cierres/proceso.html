<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Cierre de Inventario</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container mt-4">
      <h2 th:if="${cierre.estado == 'PRE-COMPLETADO'}">
        üìä Cierre de Inventario - Pre-Completado
      </h2>
      <h2 th:if="${cierre.estado == 'EN_PROCESO'}">
        üìä Cierre de Inventario - En Proceso
      </h2>

      <div class="alert alert-info">
        <strong>Fecha:</strong>
        <span
          th:text="${#temporals.format(cierre.fecha, 'dd/MM/yyyy HH:mm')}"
        ></span>
        | <strong>Usuario:</strong> <span th:text="${cierre.usuario.nombreUsuario}"></span> |
        <strong>Estado:</strong>
        <span th:text="${cierre.estado}" class="badge bg-warning"></span>
      </div>

      <form
        th:action="${cierre.estado == 'EN_PROCESO'} ? 
                    @{/cierres/completar/{id}(id=${cierre.id})} : 
                    @{/cierres/completar-definitivo/{id}(id=${cierre.id})}"
        method="post"
      >
        <table class="table table-striped">
          <thead>
            <tr>
              <th>√çtem</th>
              <th>Stock Te√≥rico</th>
              <th>Stock Real</th>
              <th>Merma</th>
              <th>Desperdicio</th>
              <th>Diferencia</th>
              <th>Valor</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="detalle, detalleStat : ${detalles}">
              <input
                type="hidden"
                th:name="detalles[__${detalleStat.index}__].id"
                th:value="${detalle.id}"
              />

              <td>
                <span
                  th:if="${detalle.ingrediente != null}"
                  th:text="${detalle.ingrediente.nombre}"
                ></span>
                <span
                  th:if="${detalle.producto != null}"
                  th:text="${detalle.producto.nombre}"
                ></span>
              </td>

              <td th:text="${detalle.stockTeorico}"></td>

              <td>
                <input
                  type="number"
                  step="0.01"
                  th:name="detalles[__${detalleStat.index}__].stockReal"
                  th:value="${detalle.stockReal}"
                  class="form-control form-control-sm"
                  required
                />
              </td>

              <td>
                <input
                  type="number"
                  step="0.01"
                  th:name="detalles[__${detalleStat.index}__].merma"
                  th:value="${detalle.stockMerma}"
                  class="form-control form-control-sm"
                />
              </td>

              <td>
                <input
                  type="number"
                  step="0.01"
                  th:name="detalles[__${detalleStat.index}__].desperdicio"
                  th:value="${detalle.stockDesperdicio}"
                  class="form-control form-control-sm"
                />
              </td>

              <td
                th:text="${detalle.diferencia}"
                th:class="${detalle.diferencia < 0} ? 'text-danger' : 'text-success'"
              ></td>

              <td
                th:text="${#numbers.formatCurrency(detalle.valorDiferencia)}"
                th:class="${detalle.valorDiferencia < 0} ? 'text-danger' : 'text-success'"
              ></td>
            </tr>
          </tbody>
        </table>

        <button
          type="submit"
          class="btn btn-success"
          th:if="${cierre.estado == 'EN_PROCESO'}"
        >
          ‚úÖ Completar Pre-Cierre
        </button>

        <button
          type="submit"
          class="btn btn-danger"
          th:if="${cierre.estado == 'PRE-COMPLETADO'}"
        >
          ‚úÖ Completar Cierre Definitivo
        </button>

        <a th:href="@{/cierres}" class="btn btn-secondary">Cancelar</a>
      </form>
    </div>
  </body>
</html>
