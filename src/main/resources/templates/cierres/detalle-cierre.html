<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Detalle de Cierre</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container mt-4">
      <h2>
        üìã Detalle de Cierre -
        <span th:text="${#temporals.format(cierre.fecha, 'dd/MM/yyyy')}"></span>
      </h2>

      <div class="card mb-4">
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <strong>Estado:</strong>
              <span
                th:if="${cierre.estado == 'COMPLETADO'}"
                class="badge bg-success"
                >COMPLETADO</span
              >
              <span
                th:if="${cierre.estado == 'PRE-COMPLETADO'}"
                class="badge bg-warning"
                >PRE-COMPLETADO</span
              >
            </div>
            <div class="col-md-3">
              <strong>Usuario:</strong>
              <span th:text="${cierre.usuario.nombreUsuario}"></span>
            </div>
            <div class="col-md-3">
              <strong>Fecha:</strong>
              <span
                th:text="${#temporals.format(cierre.fecha, 'dd/MM/yyyy HH:mm')}"
              ></span>
            </div>
            <div class="col-md-3">
              <strong>Observaciones:</strong>
              <span th:text="${cierre.observaciones}"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Totales -->
      <div class="row mb-3">
        <div class="col-md-3">
          <div class="card bg-success text-white">
            <div class="card-body text-center">
              <h6>Ventas del D√≠a</h6>
              <h4 th:text="${#numbers.formatCurrency(cierre.totalVentas)}"></h4>
              <small
                th:text="'(' + ${cierre.cantidadFacturas} + ' facturas)'"
              ></small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-light">
            <div class="card-body text-center">
              <h6>Diferencia Inventario</h6>
              <h4
                th:text="${#numbers.formatCurrency(totalValorDiferencia)}"
                th:class="${totalValorDiferencia < 0} ? 'text-danger' : 'text-success'"
              ></h4>

              <small th:if="${cierre.totalVentas > 0}">
                <!-- CORRECCI√ìN: usa totalValorDiferencia en lugar de totalDiferencia -->
                <span
                  th:with="porcentaje=${(totalValorDiferencia/cierre.totalVentas)*100}"
                  th:text="${#numbers.formatDecimal(porcentaje, 1, 2)}"
                >
                </span>
                % de las ventas
              </small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-warning text-dark">
            <div class="card-body text-center">
              <h6>Merma Total</h6>
              <h4 th:text="${#numbers.formatCurrency(totalValorMerma)}"></h4>
              <small th:if="${cierre.totalVentas > 0}">
                <span
                  th:with="porcentajeMerma=${(totalValorMerma/cierre.totalVentas)*100}"
                  th:text="${#numbers.formatDecimal(porcentajeMerma, 1, 2)}"
                ></span>
                % de las ventas
              </small>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card bg-danger text-white">
            <div class="card-body text-center">
              <h6>Desperdicio Total</h6>
              <h4
                th:text="${#numbers.formatCurrency(totalValorDesperdicio)}"
              ></h4>
              <small th:if="${cierre.totalVentas > 0}">
                <span
                  th:with="porcentajeDesperdicio=${(totalValorDesperdicio/cierre.totalVentas)*100}"
                  th:text="${#numbers.formatDecimal(porcentajeDesperdicio, 1, 2)}"
                ></span>
                % de las ventas
              </small>
            </div>
          </div>
        </div>
      </div>
      <!-- Tabla de detalles -->
      <table class="table table-striped">
        <thead>
          <tr>
            <th>√çtem</th>
            <th>Stock Te√≥rico</th>
            <th>Stock Real</th>
            <th>Merma</th>
            <th>Desperdicio</th>
            <th>Diferencia</th>
            <th>Valor Diferencia</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="detalle : ${detalles}">
            <td>
              <span
                th:if="${detalle.ingrediente != null}"
                th:text="${detalle.ingrediente.nombre}"
              ></span>
              <span
                th:if="${detalle.producto != null}"
                th:text="${detalle.producto.nombre}"
              ></span>
            </td>
            <td th:text="${detalle.stockTeorico}"></td>
            <td th:text="${detalle.stockReal}"></td>
            <td th:text="${detalle.stockMerma}" class="text-warning"></td>
            <td th:text="${detalle.stockDesperdicio}" class="text-danger"></td>
            <td
              th:text="${detalle.diferencia}"
              th:class="${detalle.diferencia < 0} ? 'text-danger' : 'text-success'"
            ></td>
            <td
              th:text="${#numbers.formatCurrency(detalle.valorDiferencia)}"
              th:class="${detalle.valorDiferencia < 0} ? 'text-danger' : 'text-success'"
            ></td>
          </tr>
        </tbody>
      </table>

      <a th:href="@{/cierres}" class="btn btn-secondary">Volver a Cierres</a>
    </div>
  </body>
</html>
